<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_2.6.33.1/src/arch/i386/restart_fixup.h File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d5/d98/i386_2restart__fixup_8h.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">restart_fixup.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="../../d5/d98/i386_2restart__fixup_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:abe85f8ad9f13d5136489635072621d35"><td class="memItemLeft" align="right" valign="top">static long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d98/i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35">tcmi_restart_fixup</a> (struct restart_block *restart)</td></tr>
<tr class="memdesc:abe85f8ad9f13d5136489635072621d35"><td class="mdescLeft">&#160;</td><td class="mdescRight">This method is used for handling migration restart.  <a href="#abe85f8ad9f13d5136489635072621d35">More...</a><br/></td></tr>
<tr class="separator:abe85f8ad9f13d5136489635072621d35"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab4c4006ed5078f2b37308ef3ad5f622e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d98/i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e">fixup_64bit_stack</a> (struct restart_block *restart, struct pt_regs *regs)</td></tr>
<tr class="memdesc:ab4c4006ed5078f2b37308ef3ad5f622e"><td class="mdescLeft">&#160;</td><td class="mdescRight">If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space.  <a href="#ab4c4006ed5078f2b37308ef3ad5f622e">More...</a><br/></td></tr>
<tr class="separator:ab4c4006ed5078f2b37308ef3ad5f622e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ce254bfcbf5391b17d83aba09345077"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d98/i386_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077">tcmi_resolve_restart_block</a> (struct task_struct *task, struct pt_regs *regs, enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a> from_arch, int <a class="el" href="../../d6/db7/tcmi__ckpt_8h.html#a261c3d1e52cdc2e37e08e2dea3f1a138">is_32bit_application</a>)</td></tr>
<tr class="memdesc:a6ce254bfcbf5391b17d83aba09345077"><td class="mdescLeft">&#160;</td><td class="mdescRight">Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time.  <a href="#a6ce254bfcbf5391b17d83aba09345077">More...</a><br/></td></tr>
<tr class="separator:a6ce254bfcbf5391b17d83aba09345077"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ab4c4006ed5078f2b37308ef3ad5f622e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void fixup_64bit_stack </td>
          <td>(</td>
          <td class="paramtype">struct restart_block *&#160;</td>
          <td class="paramname"><em>restart</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pt_regs *&#160;</td>
          <td class="paramname"><em>regs</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space. </p>

<p>Definition at line <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00049">49</a> of file <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d6/d01/dbg_8h_source.html#l00220">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00072">tcmi_resolve_restart_block()</a>.</p>
<div class="fragment"><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                                                                                           {</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> stackEbp;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO4, <span class="stringliteral">&quot;64bit stack&quot;</span>);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">/* Avoid all poping after syscall as we have a different stack */</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    restart-&gt;arg1 = 0xffffe413;         </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">/* Extract ebp stored on top of the stack */</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    stackEbp = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>*)(regs-&gt;sp));</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">/* Fixup both pointers to ebp */</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    regs-&gt;bp = stackEbp;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    restart-&gt;arg2 = stackEbp;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">/* Fixup stack length (unpopped ebp; ecx &amp; edx were not pushed on stack by 64 bit) */</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    regs-&gt;sp += 4;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a6ce254bfcbf5391b17d83aba09345077"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int tcmi_resolve_restart_block </td>
          <td>(</td>
          <td class="paramtype">struct task_struct *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pt_regs *&#160;</td>
          <td class="paramname"><em>regs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a>&#160;</td>
          <td class="paramname"><em>from_arch</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_32bit_application</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time. </p>
<p>The main motivaction for this is to restore original AX register.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">task</td><td>Current task </td></tr>
    <tr><td class="paramname">regs</td><td>Current registers of the task </td></tr>
    <tr><td class="paramname">is_32bit_application</td><td>1, if application is 32 bit </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success </dd></dl>

<p>Definition at line <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00072">72</a> of file <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d2/def/arch__ids_8h_source.html#l00008">ARCH_X86_64</a>, <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00049">fixup_64bit_stack()</a>, <a class="el" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf">is_in_syscall()</a>, <a class="el" href="../../d6/d01/dbg_8h_source.html#l00220">mdbg</a>, and <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00022">tcmi_restart_fixup()</a>.</p>

<p>Referenced by <a class="el" href="../../db/d70/tcmi__ckptcom_8c_source.html#l00191">tcmi_ckptcom_restart()</a>.</p>
<div class="fragment"><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                                                                                                                                         {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">struct </span>restart_block* restart = &amp;(task_thread_info(task)-&gt;restart_block);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Setting tcmi sys restart block. EAX: %08lX (OEAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;</span>, regs-&gt;ax, regs-&gt;orig_ax, regs-&gt;bx, regs-&gt;cx, regs-&gt;dx);   </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">/* EAX and EIP are required to be stored, the other registers won&#39;t get affected as they are already on stack (eax will be overriden by execve return value and EIP will be altered as the userspace process will execute restart syscall) */</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    restart-&gt;arg0 = original_ax(regs);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    restart-&gt;arg1 = instruction_pointer(regs);  </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">/* </span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">           EBP needs to be restored in case we were not in syscall, because in that case we execute fake syscall to get EAX on place and this fake vsyscall will clobber EBP. If we were originally in syscall,</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">       this won&#39;t matter, because the real EBP was pushed before call and will be poped after, but in case we were not in syscall, we do not have this comfort</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">       In order to make restart code easier, we simply store and restore EBP in both cases.</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    restart-&gt;arg2 = base_pointer(regs);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart out of syscall.&quot;</span>);      </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="comment">/* Set current EIP address just before the sysenter so that the restart block is executed */</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        regs-&gt;ip = 0xffffe403;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="comment">/* In addition if we are not in syscall we do not want to use orig_eax, but rather real eax */</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        restart-&gt;arg0 = regs_return_value(regs);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordflow">if</span> ( from_arch == <a class="code" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9a0089eec22100f4609dad74f6be4ec601">ARCH_X86_64</a> &amp;&amp; restart-&gt;arg1 == 0xffffe405 ) {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="comment">/* We were in a 64 bit syscall, but it was not interrupted */</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            <a class="code" href="../../d5/d98/i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space...">fixup_64bit_stack</a>(restart, regs);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    } <span class="keywordflow">else</span> {        </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in syscall&quot;</span>);       </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">if</span> ( from_arch == <a class="code" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9a0089eec22100f4609dad74f6be4ec601">ARCH_X86_64</a> &amp;&amp; restart-&gt;arg1 == 0xffffe405) { <span class="comment">// We were in 64 bit syscall of AMD =&gt; we need fixup</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <a class="code" href="../../d5/d98/i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space...">fixup_64bit_stack</a>(restart, regs);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    restart-&gt;fn = <a class="code" href="../../d5/d98/i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35" title="This method is used for handling migration restart.">tcmi_restart_fixup</a>;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d5/d98/i386_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph.png" border="0" usemap="#d5/d98/i386_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph" alt=""/></div>
<map name="d5/d98/i386_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph" id="d5/d98/i386_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph">
<area shape="rect" id="node2" href="../../d5/d98/i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space..." alt="" coords="193,5,316,32"/><area shape="rect" id="node3" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call." alt="" coords="206,56,303,83"/><area shape="rect" id="node4" href="../../d5/d98/i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35" title="This method is used for handling migration restart." alt="" coords="192,107,317,133"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abe85f8ad9f13d5136489635072621d35"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static long tcmi_restart_fixup </td>
          <td>(</td>
          <td class="paramtype">struct restart_block *&#160;</td>
          <td class="paramname"><em>restart</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This method is used for handling migration restart. </p>
<p>There are 2 cases:</p>
<p>Application was in syscall: We cannot directly restart the syscall, because as a part of process restart we do execve. The execve, if it succeeds, will set EAX to 0. This means, the restarted syscall will not be the original syscall, but sys_restartsyscall. Restart syscall is handled by the custom registered method in our case this method.</p>
<p>Application was not in syscall: We cannot simply restart the application, because again the execve will override EAX content! Here we use a special trick. We can assume EAX will contain 0 as in previous case (=execve succeeded, otherwise the program would not start anyway). With EAX == 0 we can set fake EIP just before the vsyscall sysenter (assuming it is mapped in the process on expected address) This way we will get sysretart called immediately and from the special restart function we return proper eax (and eip) in order to make the application working as expected, with all registers set correctly. </p>

<p>Definition at line <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00022">22</a> of file <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d4/d83/tcmi__ckpt__openfile_8h_source.html#l00127">flags</a>, and <a class="el" href="../../d6/d01/dbg_8h_source.html#l00220">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../d5/d98/i386_2restart__fixup_8h_source.html#l00072">tcmi_resolve_restart_block()</a>.</p>
<div class="fragment"><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;                                                              {</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="keyword">struct </span>pt_regs *regs = task_pt_regs(current);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Calling tcmi sys restart. Thread Flags: %08lX EAX: %08lX (OEAX: %08lX Return EAX: %08lX) SP: %16lX BP: %16lX (Restore BP: %16lX) IP: %08lX (Restore IP: %08lX)&quot;</span>, current_thread_info()-&gt;<a class="code" href="../../d4/d83/tcmi__ckpt__openfile_8h.html#a38a8a1678784eecc1ffcc0685dbcce97" title="flags specified by the user when opening the file">flags</a>, regs_return_value(regs), original_ax(regs), restart-&gt;arg0, stack_pointer(regs), base_pointer(regs), restart-&gt;arg2, regs-&gt;ip, restart-&gt;arg1);</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    <span class="comment">/*mdbg(INFO3, &quot;Calling tcmi sys restart. EAX: %08lX (OEAX: %08lX Return EAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;, regs-&gt;eax, regs-&gt;orig_eax, restart-&gt;arg0, regs-&gt;ebx, regs-&gt;ecx, regs-&gt;edx);*/</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">/* TODO: Reset restart_block? */</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">/* Reset EIP to original value (either again just before the syscall, or on the other completely unrelated address */</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    regs-&gt;ip = restart-&gt;arg1;           </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    </div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">/* Restore ebp, in case we were in syscall it won&#39;t have any effect, otherwise it will set proper EBP for the application */</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    base_pointer(regs) = restart-&gt;arg2;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">/* To prevent ECX &amp; EDX clobbering via sysexit */</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    set_thread_flag(TIF_IRET);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">/* </span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">           This is a trick how to get original EAX onto the stack.. return value of this syscall is what gets onto the stack </span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">       When the syscall gets executed again (as we again set EIP) it will finally use correct EAX. The other registers are unclobbered and so we do not need to restore them</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">       If we were not originally in syscall, we will simply continue with correct EAX where we finished.</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keywordflow">return</span> restart-&gt;arg0;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_8f82a767cc51fe89d179736eabaccdf4.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_9385db0d21c3799d77ed98cab2ee4df0.html">kernel_2.6.33.1</a></li><li class="navelem"><a class="el" href="../../dir_0795b8fbe000fdfda95a2efc60cc76e3.html">src</a></li><li class="navelem"><a class="el" href="../../dir_8e63732057d12160ad41c278ba05f590.html">arch</a></li><li class="navelem"><a class="el" href="../../dir_0a1d02ac3abe423776d6b5ab6fceefc9.html">i386</a></li><li class="navelem"><a class="el" href="../../d5/d98/i386_2restart__fixup_8h.html">restart_fixup.h</a></li>
    <li class="footer">Generated on Sun Apr 7 2013 23:19:40 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
