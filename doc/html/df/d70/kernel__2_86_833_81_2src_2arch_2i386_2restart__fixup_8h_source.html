<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_2.6.33.1/src/arch/i386/restart_fixup.h Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">restart_fixup.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#ifndef ARG_I386_RESTART_FIXUP_H</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ARG_I386_RESTART_FIXUP_H</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// TODO: Use vsdo attribute of mm_context to check for correct location of vsdo</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// TODO: Disable making of checkpoints, when we are in some part of vsdo other than syscall itself (otherwise we have to fixup stack &amp; args for every possible EIP)</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">/** </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * This method is used for handling migration restart. There are 2 cases:</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * Application was in syscall:</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *  We cannot directly restart the syscall, because as a part of process restart we do execve. The execve,</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * if it succeeds, will set EAX to 0. This means, the restarted syscall will not be the original syscall, but sys_restartsyscall.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * Restart syscall is handled by the custom registered method in our case this method.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * Application was not in syscall:</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *  We cannot simply restart the application, because again the execve will override EAX content! Here we use a special trick.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * We can assume EAX will contain 0 as in previous case (=execve succeeded, otherwise the program would not start anyway).</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * With EAX == 0 we can set fake EIP just before the vsyscall sysenter (assuming it is mapped in the process on expected address)</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * This way we will get sysretart called immediately and from the special restart function we return proper eax (and eip) in order to make </span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * the application working as expected, with all registers set correctly.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35">   22</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35" title="This method is used for handling migration restart.">tcmi_restart_fixup</a>(<span class="keyword">struct</span> restart_block *restart) {</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="keyword">struct </span>pt_regs *regs = task_pt_regs(current);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Calling tcmi sys restart. Thread Flags: %08lX EAX: %08lX (OEAX: %08lX Return EAX: %08lX) SP: %16lX BP: %16lX (Restore BP: %16lX) IP: %08lX (Restore IP: %08lX)&quot;</span>, current_thread_info()-&gt;<a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a38a8a1678784eecc1ffcc0685dbcce97" title="flags specified by the user when opening the file">flags</a>, regs_return_value(regs), original_ax(regs), restart-&gt;arg0, stack_pointer(regs), base_pointer(regs), restart-&gt;arg2, regs-&gt;ip, restart-&gt;arg1);</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    <span class="comment">/*mdbg(INFO3, &quot;Calling tcmi sys restart. EAX: %08lX (OEAX: %08lX Return EAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;, regs-&gt;eax, regs-&gt;orig_eax, restart-&gt;arg0, regs-&gt;ebx, regs-&gt;ecx, regs-&gt;edx);*/</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">/* TODO: Reset restart_block? */</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">/* Reset EIP to original value (either again just before the syscall, or on the other completely unrelated address */</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    regs-&gt;ip = restart-&gt;arg1;           </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    </div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">/* Restore ebp, in case we were in syscall it won&#39;t have any effect, otherwise it will set proper EBP for the application */</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    base_pointer(regs) = restart-&gt;arg2;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">/* To prevent ECX &amp; EDX clobbering via sysexit */</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    set_thread_flag(TIF_IRET);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">/* </span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">           This is a trick how to get original EAX onto the stack.. return value of this syscall is what gets onto the stack </span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">       When the syscall gets executed again (as we again set EIP) it will finally use correct EAX. The other registers are unclobbered and so we do not need to restore them</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">       If we were not originally in syscall, we will simply continue with correct EAX where we finished.</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keywordflow">return</span> restart-&gt;arg0;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;}</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">/** </span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> * If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space.</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e">   49</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space...">fixup_64bit_stack</a>(<span class="keyword">struct</span> restart_block* restart, <span class="keyword">struct</span> pt_regs* regs)  {</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> stackEbp;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO4, <span class="stringliteral">&quot;64bit stack&quot;</span>);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">/* Avoid all poping after syscall as we have a different stack */</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    restart-&gt;arg1 = 0xffffe413;         </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">/* Extract ebp stored on top of the stack */</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    stackEbp = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>*)(regs-&gt;sp));</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">/* Fixup both pointers to ebp */</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    regs-&gt;bp = stackEbp;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    restart-&gt;arg2 = stackEbp;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">/* Fixup stack length (unpopped ebp; ecx &amp; edx were not pushed on stack by 64 bit) */</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    regs-&gt;sp += 4;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;}</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"> * Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time. The main motivaction for this is to </span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"> * restore original AX register.</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment"> * @param task Current task</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"> * @param regs Current registers of the task</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"> * @param is_32bit_application 1, if application is 32 bit</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment"> * @return 0 on success</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077">   72</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077" title="Registeres restart block and schedules restart syscall to be executed after the process resumes users...">tcmi_resolve_restart_block</a>(<span class="keyword">struct</span> task_struct* task, <span class="keyword">struct</span> pt_regs* regs, <span class="keyword">enum</span> <a class="code" href="../../dd/d06/kernel__2_86_833_81_2src_2arch_2arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9" title="Enumeration representing all supported architecture types.">arch_ids</a> from_arch, <span class="keywordtype">int</span> <a class="code" href="../../d6/d99/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt_8h.html#a261c3d1e52cdc2e37e08e2dea3f1a138" title="Flag, indicating whether the checkpointed application was 32 bit application (otherwise 64 bit is ass...">is_32bit_application</a>) {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">struct </span>restart_block* restart = &amp;(task_thread_info(task)-&gt;restart_block);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Setting tcmi sys restart block. EAX: %08lX (OEAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;</span>, regs-&gt;ax, regs-&gt;orig_ax, regs-&gt;bx, regs-&gt;cx, regs-&gt;dx);   </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">/* EAX and EIP are required to be stored, the other registers won&#39;t get affected as they are already on stack (eax will be overriden by execve return value and EIP will be altered as the userspace process will execute restart syscall) */</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    restart-&gt;arg0 = original_ax(regs);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    restart-&gt;arg1 = instruction_pointer(regs);  </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">/* </span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">           EBP needs to be restored in case we were not in syscall, because in that case we execute fake syscall to get EAX on place and this fake vsyscall will clobber EBP. If we were originally in syscall,</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">       this won&#39;t matter, because the real EBP was pushed before call and will be poped after, but in case we were not in syscall, we do not have this comfort</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">       In order to make restart code easier, we simply store and restore EBP in both cases.</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    restart-&gt;arg2 = base_pointer(regs);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d1e/kernel__2_86_833_81_2src_2arch_2common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart out of syscall.&quot;</span>);      </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="comment">/* Set current EIP address just before the sysenter so that the restart block is executed */</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        regs-&gt;ip = 0xffffe403;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="comment">/* In addition if we are not in syscall we do not want to use orig_eax, but rather real eax */</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        restart-&gt;arg0 = regs_return_value(regs);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordflow">if</span> ( from_arch == <a class="code" href="../../dd/d06/kernel__2_86_833_81_2src_2arch_2arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9a0089eec22100f4609dad74f6be4ec601">ARCH_X86_64</a> &amp;&amp; restart-&gt;arg1 == 0xffffe405 ) {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="comment">/* We were in a 64 bit syscall, but it was not interrupted */</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space...">fixup_64bit_stack</a>(restart, regs);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    } <span class="keywordflow">else</span> {        </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in syscall&quot;</span>);       </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">if</span> ( from_arch == <a class="code" href="../../dd/d06/kernel__2_86_833_81_2src_2arch_2arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9a0089eec22100f4609dad74f6be4ec601">ARCH_X86_64</a> &amp;&amp; restart-&gt;arg1 == 0xffffe405) { <span class="comment">// We were in 64 bit syscall of AMD =&gt; we need fixup</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#ab4c4006ed5078f2b37308ef3ad5f622e" title="If we were in 64 bit syscall, we have to fixup some regs to work correctly after resume to user space...">fixup_64bit_stack</a>(restart, regs);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    restart-&gt;fn = <a class="code" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html#abe85f8ad9f13d5136489635072621d35" title="This method is used for handling migration restart.">tcmi_restart_fixup</a>;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;}</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_08d237fc27d4ecd563f71c5d52f2fecc.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_351788bb6e23fe2c44c0fb926ab59c0b.html">kernel_2.6.33.1</a></li><li class="navelem"><a class="el" href="../../dir_20c5e2ce0b5aae09914675fb60613a2c.html">src</a></li><li class="navelem"><a class="el" href="../../dir_651b2678ed5b3ccf093a342e37a84f37.html">arch</a></li><li class="navelem"><a class="el" href="../../dir_5184fca2a315d44de396fb0e46d012df.html">i386</a></li><li class="navelem"><a class="el" href="../../df/d70/kernel__2_86_833_81_2src_2arch_2i386_2restart__fixup_8h.html">restart_fixup.h</a></li>
    <li class="footer">Generated on Mon Apr 1 2013 16:09:46 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
