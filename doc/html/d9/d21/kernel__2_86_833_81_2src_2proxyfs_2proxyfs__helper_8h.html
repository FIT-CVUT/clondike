<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_2.6.33.1/src/proxyfs/proxyfs_helper.h File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">proxyfs_helper.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;linux/fs.h&gt;</code><br/>
<code>#include &lt;linux/fs_struct.h&gt;</code><br/>
<code>#include &lt;linux/fdtable.h&gt;</code><br/>
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="../../closed.png" alt="+"/> Include dependency graph for proxyfs_helper.h:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../dc/d91/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h__incl.png" border="0" usemap="#C_1_2CLONDIKE_2clondike_2sources_2kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h" alt=""/></div>
</div>
</div>
<p><a href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a074be037b0aae4d248a61c90c2c68737"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a074be037b0aae4d248a61c90c2c68737">is_proxyfs_file</a> (const char *path)</td></tr>
<tr class="memdesc:a074be037b0aae4d248a61c90c2c68737"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks, whether the file is proxyfs file.  <a href="#a074be037b0aae4d248a61c90c2c68737">More...</a><br/></td></tr>
<tr class="separator:a074be037b0aae4d248a61c90c2c68737"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a25be89ac94beb85ee51564c78d4031d7"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a25be89ac94beb85ee51564c78d4031d7">is_dev_null</a> (const char *path)</td></tr>
<tr class="memdesc:a25be89ac94beb85ee51564c78d4031d7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns true, if the path points to a dev null file.  <a href="#a25be89ac94beb85ee51564c78d4031d7">More...</a><br/></td></tr>
<tr class="separator:a25be89ac94beb85ee51564c78d4031d7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae73c5991f03548d8f100d7200d80113e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#ae73c5991f03548d8f100d7200d80113e">create_proxyfs_name</a> (struct task_struct *owning_task, char *buffer, unsigned long proxy_ident)</td></tr>
<tr class="memdesc:ae73c5991f03548d8f100d7200d80113e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Creates a name of a proxy file.  <a href="#ae73c5991f03548d8f100d7200d80113e">More...</a><br/></td></tr>
<tr class="separator:ae73c5991f03548d8f100d7200d80113e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab59a1cd53be257804c046bd384ea59ad"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#ab59a1cd53be257804c046bd384ea59ad">alter_proxyfs_name_task_change</a> (const char *old_name, pid_t new_owner_pid, char *buffer)</td></tr>
<tr class="memdesc:ab59a1cd53be257804c046bd384ea59ad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Modifies proxyfs file name to reflect a new owner of the file.  <a href="#ab59a1cd53be257804c046bd384ea59ad">More...</a><br/></td></tr>
<tr class="separator:ab59a1cd53be257804c046bd384ea59ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afd09b6bc667dba6516ff4458eb0dabad"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#afd09b6bc667dba6516ff4458eb0dabad">resolve_duplicates</a> (int modified_fd, struct file *modified_file)</td></tr>
<tr class="memdesc:afd09b6bc667dba6516ff4458eb0dabad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Helper method, that is used for altering file names on distant fork.  <a href="#afd09b6bc667dba6516ff4458eb0dabad">More...</a><br/></td></tr>
<tr class="separator:afd09b6bc667dba6516ff4458eb0dabad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe83a59a45354c9be0c0d92d6ef4c307"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#afe83a59a45354c9be0c0d92d6ef4c307">proxyfs_clone_file_names</a> (pid_t new_owner_pid)</td></tr>
<tr class="memdesc:afe83a59a45354c9be0c0d92d6ef4c307"><td class="mdescLeft">&#160;</td><td class="mdescRight">This method is used after remote-fork on a client side.  <a href="#afe83a59a45354c9be0c0d92d6ef4c307">More...</a><br/></td></tr>
<tr class="separator:afe83a59a45354c9be0c0d92d6ef4c307"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9c20f5bd7542a43136e9ac435aa9dee5"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a9c20f5bd7542a43136e9ac435aa9dee5">proxyfs_sync_files_on_exit</a> (void)</td></tr>
<tr class="memdesc:a9c20f5bd7542a43136e9ac435aa9dee5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Synchronizes all files open by "current" process.  <a href="#a9c20f5bd7542a43136e9ac435aa9dee5">More...</a><br/></td></tr>
<tr class="separator:a9c20f5bd7542a43136e9ac435aa9dee5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a313449d5e6dd4f8ab3ecc7ca8d2ae1b2"><td class="memItemLeft" align="right" valign="top">static const char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2">PROXYFS_MNT_POINT</a> [] = &quot;/mnt/proxy&quot;</td></tr>
<tr class="memdesc:a313449d5e6dd4f8ab3ecc7ca8d2ae1b2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains helper methods for working with proxyfs.  <a href="#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2">More...</a><br/></td></tr>
<tr class="separator:a313449d5e6dd4f8ab3ecc7ca8d2ae1b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ab59a1cd53be257804c046bd384ea59ad"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int alter_proxyfs_name_task_change </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">pid_t&#160;</td>
          <td class="paramname"><em>new_owner_pid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Modifies proxyfs file name to reflect a new owner of the file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">old_name</td><td>Old name of proxy file </td></tr>
    <tr><td class="paramname">new_owner_pid</td><td>CCN pid of the task, that is owning a reference to the physical file (new task) </td></tr>
    <tr><td class="paramname">buffer</td><td>Output buffer to be filled with the path </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on successful change, 1 if no change was required, negative error code otherwise </dd></dl>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00052">52</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00020">is_proxyfs_file()</a>, <a class="el" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h_source.html#l00220">mdbg</a>, and <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00012">PROXYFS_MNT_POINT</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00112">proxyfs_clone_file_names()</a>.</p>
<div class="fragment"><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                                                                                                          {</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a074be037b0aae4d248a61c90c2c68737" title="Checks, whether the file is proxyfs file.">is_proxyfs_file</a>(old_name) ) {</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR2, <span class="stringliteral">&quot;Old name is not a proxyfs file name! Name: %s&quot;</span>, old_name);</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordtype">int</span> proxyfs_mnt_point_len = strlen(<a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2" title="Contains helper methods for working with proxyfs.">PROXYFS_MNT_POINT</a>);  </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        pid_t old_pid;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> proxy_ident;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        sscanf(old_name + proxyfs_mnt_point_len + 1, <span class="stringliteral">&quot;%d-%lu&quot;</span>,&amp;old_pid, &amp;proxy_ident);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordflow">if</span> ( old_pid == new_owner_pid )</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            <span class="keywordflow">return</span> 1; <span class="comment">// No change required</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        sprintf(buffer, <span class="stringliteral">&quot;%s/%d-%lu&quot;</span>,<a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2" title="Contains helper methods for working with proxyfs.">PROXYFS_MNT_POINT</a>, new_owner_pid, proxy_ident);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;};</div>
</div><!-- fragment -->
<p><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_ab59a1cd53be257804c046bd384ea59ad_cgraph.png" border="0" usemap="#d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_ab59a1cd53be257804c046bd384ea59ad_cgraph" alt=""/></div>
<map name="d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_ab59a1cd53be257804c046bd384ea59ad_cgraph" id="d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_ab59a1cd53be257804c046bd384ea59ad_cgraph">
<area shape="rect" id="node2" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a074be037b0aae4d248a61c90c2c68737" title="Checks, whether the file is proxyfs file." alt="" coords="189,12,293,39"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae73c5991f03548d8f100d7200d80113e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void create_proxyfs_name </td>
          <td>(</td>
          <td class="paramtype">struct task_struct *&#160;</td>
          <td class="paramname"><em>owning_task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>proxy_ident</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Creates a name of a proxy file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">owning_task</td><td>Task, that is owning a reference to the physical file </td></tr>
    <tr><td class="paramname">buffer</td><td>Output buffer to be filled with the path </td></tr>
    <tr><td class="paramname">proxy_ident</td><td>Identifier of the file in the proxy file system </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00039">39</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00012">PROXYFS_MNT_POINT</a>.</p>

<p>Referenced by <a class="el" href="../../d5/d91/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8c_source.html#l00170">tcmi_ckpt_openfile_write_newfd()</a>.</p>
<div class="fragment"><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;                                                                                                                 {</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    sprintf(buffer, <span class="stringliteral">&quot;%s/%d-%lu&quot;</span>, <a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2" title="Contains helper methods for working with proxyfs.">PROXYFS_MNT_POINT</a>, task_tgid_vnr(owning_task), proxy_ident);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a25be89ac94beb85ee51564c78d4031d7"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int is_dev_null </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns true, if the path points to a dev null file. </p>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00028">28</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>Referenced by <a class="el" href="../../d5/d91/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8c_source.html#l00170">tcmi_ckpt_openfile_write_newfd()</a>.</p>
<div class="fragment"><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;                                                {</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keywordflow">return</span> strncmp(path, <span class="stringliteral">&quot;/dev/null&quot;</span>, 9) == 0;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a074be037b0aae4d248a61c90c2c68737"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int is_proxyfs_file </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Checks, whether the file is proxyfs file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">path</td><td>Path to the file </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 if the file is proxyfs file, 0 otherwise </dd></dl>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00020">20</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00012">PROXYFS_MNT_POINT</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00052">alter_proxyfs_name_task_change()</a>, <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00112">proxyfs_clone_file_names()</a>, and <a class="el" href="../../d5/d91/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8c_source.html#l00170">tcmi_ckpt_openfile_write_newfd()</a>.</p>
<div class="fragment"><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;                                                    {</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="keywordtype">int</span> proxyfs_mnt_point_len = strlen(<a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2" title="Contains helper methods for working with proxyfs.">PROXYFS_MNT_POINT</a>);</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="keywordflow">return</span> strncmp(path, <a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a313449d5e6dd4f8ab3ecc7ca8d2ae1b2" title="Contains helper methods for working with proxyfs.">PROXYFS_MNT_POINT</a>, proxyfs_mnt_point_len) == 0;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="afe83a59a45354c9be0c0d92d6ef4c307"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int proxyfs_clone_file_names </td>
          <td>(</td>
          <td class="paramtype">pid_t&#160;</td>
          <td class="paramname"><em>new_owner_pid</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This method is used after remote-fork on a client side. </p>
<p>It will iterate all open files of the client and if the file is a proxy file, it will be closed and a new file will be opened instead.</p>
<p>On the serverside, there are created appropriated proxy files after the fork of shadow process, so they are already prepared to be used.</p>
<p>By using this "file clonning" mechanism, we ensure that we have independend file connections from parent and child and so we can migrate parent on a different node that the child.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">new_owner_pid</td><td>Pid of the process, for which we are making the clone (pid on CCN!) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on successs </dd></dl>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00112">112</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00052">alter_proxyfs_name_task_change()</a>, <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00123">fd</a>, <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00127">flags</a>, <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00020">is_proxyfs_file()</a>, <a class="el" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h_source.html#l00220">mdbg</a>, <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00129">mode</a>, <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00125">pos</a>, and <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00075">resolve_duplicates()</a>.</p>

<p>Referenced by <a class="el" href="../../de/dc7/kernel__2_86_833_81_2src_2tcmi_2task_2tcmi__guesttask_8c_source.html#l00392">tcmi_guesttask_post_fork_set_tid()</a>.</p>
<div class="fragment"><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                                                                {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a4a05f54831975728fbdcadcb6fc4d40e" title="file descriptor">fd</a>, res = 0;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keyword">struct </span>file* file;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> page;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordtype">char</span>* pathname;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    mm_segment_t old_fs;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="comment">/* resolve the path name. */</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">if</span> (!(page = __get_free_page(GFP_KERNEL))) {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Can&#39;t allocate page for file pathname!&quot;</span>);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    old_fs = get_fs();</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    set_fs(get_ds());</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">for</span> (fd = 0, file = current-&gt;files-&gt;fdt-&gt;fd[fd];                    \</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;         fd &lt; current-&gt;files-&gt;fdt-&gt;max_fds; fd++, file = current-&gt;files-&gt;fdt-&gt;fd[fd])       \</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        if (FD_ISSET(fd, current-&gt;files-&gt;fdt-&gt;open_fds)) {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            <span class="comment">// Same &quot;hack&quot; with -1000 as in tcmi_ckpt_openfile.. see there for cmnt</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            <span class="keywordflow">if</span> (IS_ERR(pathname = d_path(&amp;file-&gt;f_path, (<span class="keywordtype">char</span>*)page, PAGE_SIZE - 1000))) {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Can&#39;t resolve pathname for &#39;%s&#39;&quot;</span>, file-&gt;f_dentry-&gt;d_name.name);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                res = -EINVAL;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            }</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a074be037b0aae4d248a61c90c2c68737" title="Checks, whether the file is proxyfs file.">is_proxyfs_file</a>(pathname) ) {</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                u_int32_t <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a38a8a1678784eecc1ffcc0685dbcce97" title="flags specified by the user when opening the file">flags</a>;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                u_int32_t <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a511a8806c63b72ff1b8b5f1a7f9d7c77" title="access mode for the file">mode</a>;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                u_int64_t <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#ab98c51e637d02736ae8f5cf0cf0d416e" title="current position in the file.">pos</a>;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                <span class="keywordtype">int</span> new_fd, alter_res;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Resolving proxy fs file %s [%d]&quot;</span>, pathname, fd);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                flags = file-&gt;f_flags;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                mode = file-&gt;f_mode;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                pos = file-&gt;f_pos;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="comment">// Change filename to new proper name               </span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                alter_res = <a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#ab59a1cd53be257804c046bd384ea59ad" title="Modifies proxyfs file name to reflect a new owner of the file.">alter_proxyfs_name_task_change</a>(pathname, new_owner_pid, (<span class="keywordtype">char</span>*)page);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                <span class="keywordflow">if</span> ( alter_res == 1 ) {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                    <span class="keywordflow">continue</span>; <span class="comment">// File does not need to be changed.. it was a duplicate and is already changed   </span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( alter_res &lt; 0 ) {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                    res = alter_res;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                    <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                pathname = (<span class="keywordtype">char</span>*)page;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                <span class="comment">// Close old file</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                sys_close(fd);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                <span class="comment">// Open new file        </span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                <span class="keywordflow">if</span> ((new_fd = do_sys_open(AT_FDCWD, pathname, flags, mode)) &lt; 0) {</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Error opening file &#39;%s&#39;, err=%d&quot;</span>, pathname, new_fd);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                    res = new_fd;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                    <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                <span class="comment">// Ensure the new file has proper id</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                <span class="keywordflow">if</span> (new_fd != fd) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Duplicating file descriptor %d into %d!&quot;</span>, new_fd, fd);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                    <span class="keywordflow">if</span> (sys_dup2(new_fd, fd) != fd) {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                        res = -EINVAL;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Error duplicating file descriptor %d into %d!&quot;</span>, new_fd, fd);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                        <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                    }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                    <span class="comment">// Close newly opened file that was not open with a proper fd</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                    sys_close(new_fd);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                <span class="comment">/* setup the file position */</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                <span class="keywordflow">if</span> (pos != vfs_llseek(current-&gt;files-&gt;fdt-&gt;fd[fd], pos, 0)) {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Failed to set position %Lx in file &#39;%s&#39;&quot;</span>, pos, pathname);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                    res = -EINVAL;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                    <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                }           </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                <span class="comment">// Resolve all other fd&#39;s that were pointing to this file.. they should not open it, they should instead duplicate the fd</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#afd09b6bc667dba6516ff4458eb0dabad" title="Helper method, that is used for altering file names on distant fork.">resolve_duplicates</a>(fd, file) ) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Failed to resolve duplicates&quot;</span>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                    res = -EINVAL;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                    <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            }</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;exit1:</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    set_fs(old_fs);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    free_page(page);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-2" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-2-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-2-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-2-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_afe83a59a45354c9be0c0d92d6ef4c307_cgraph.png" border="0" usemap="#d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_afe83a59a45354c9be0c0d92d6ef4c307_cgraph" alt=""/></div>
<map name="d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_afe83a59a45354c9be0c0d92d6ef4c307_cgraph" id="d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_afe83a59a45354c9be0c0d92d6ef4c307_cgraph">
<area shape="rect" id="node2" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#ab59a1cd53be257804c046bd384ea59ad" title="Modifies proxyfs file name to reflect a new owner of the file." alt="" coords="179,5,314,46"/><area shape="rect" id="node3" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#a074be037b0aae4d248a61c90c2c68737" title="Checks, whether the file is proxyfs file." alt="" coords="363,41,467,68"/><area shape="rect" id="node4" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html#afd09b6bc667dba6516ff4458eb0dabad" title="Helper method, that is used for altering file names on distant fork." alt="" coords="183,121,311,148"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9c20f5bd7542a43136e9ac435aa9dee5"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void proxyfs_sync_files_on_exit </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Synchronizes all files open by "current" process. </p>
<p>Iterates over all open files of the process and synchronizes it.. it is required, because the shadow process may end before the guest process and in this case some proxyfs files won't get synced on their close </p>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00208">208</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00123">fd</a>, and <a class="el" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h_source.html#l00220">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../de/dc7/kernel__2_86_833_81_2src_2tcmi_2task_2tcmi__guesttask_8c_source.html#l00237">tcmi_guesttask_exit()</a>, and <a class="el" href="../../d3/d58/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__mighooks_8c_source.html#l00135">tcmi_mighooks_do_exit()</a>.</p>
<div class="fragment"><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                                                    {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a4a05f54831975728fbdcadcb6fc4d40e" title="file descriptor">fd</a>;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keyword">struct </span>file *file;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">for</span> (fd = 0, file = current-&gt;files-&gt;fdt-&gt;fd[fd];                    </div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;         fd &lt; current-&gt;files-&gt;fdt-&gt;max_fds; fd++, file = current-&gt;files-&gt;fdt-&gt;fd[fd])   </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <span class="keywordflow">if</span> (FD_ISSET(fd, current-&gt;files-&gt;fdt-&gt;open_fds)) {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Synchronizing fd: %d&quot;</span>, fd);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            vfs_fsync(file, file-&gt;f_path.dentry, 0); <span class="comment">// TODO: Here we may do fsync unnecessarily multiple times as files can be alias by multiple fds</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    }</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="afd09b6bc667dba6516ff4458eb0dabad"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int resolve_duplicates </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>modified_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct file *&#160;</td>
          <td class="paramname"><em>modified_file</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Helper method, that is used for altering file names on distant fork. </p>
<p>. this method resolves duplicate fds that should not be changed vie close/open, but just sys_dup-ed </p>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00075">75</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>References <a class="el" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h_source.html#l00123">fd</a>, and <a class="el" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h_source.html#l00220">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00112">proxyfs_clone_file_names()</a>.</p>
<div class="fragment"><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                                                                                  {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../dd/dfa/kernel__2_86_833_81_2src_2tcmi_2ckpt_2tcmi__ckpt__openfile_8h.html#a4a05f54831975728fbdcadcb6fc4d40e" title="file descriptor">fd</a>;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keyword">struct </span>file* file;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">for</span> (fd = modified_fd+1, file = current-&gt;files-&gt;fdt-&gt;fd[fd];                    \</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;         fd &lt; current-&gt;files-&gt;fdt-&gt;max_fds; fd++, file = current-&gt;files-&gt;fdt-&gt;fd[fd])       \</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        if (FD_ISSET(fd, current-&gt;files-&gt;fdt-&gt;open_fds)) {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">// If this is a duplicate fd to file we had to modify =&gt; modify this fd to point to correct file</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">if</span> ( file == modified_file )    { </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Resolving duplicate fd %d (duplicate of %d)&quot;</span>, fd, modified_fd);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            sys_close(fd);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            <span class="keywordflow">if</span> (sys_dup2(modified_fd, fd) != fd) {</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Error duplicating file descriptor %d into %d!&quot;</span>, modified_fd, fd);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a313449d5e6dd4f8ab3ecc7ca8d2ae1b2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char PROXYFS_MNT_POINT[] = &quot;/mnt/proxy&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Contains helper methods for working with proxyfs. </p>

<p>Definition at line <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00012">12</a> of file <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html">proxyfs_helper.h</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00052">alter_proxyfs_name_task_change()</a>, <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00039">create_proxyfs_name()</a>, and <a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h_source.html#l00020">is_proxyfs_file()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_08d237fc27d4ecd563f71c5d52f2fecc.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_351788bb6e23fe2c44c0fb926ab59c0b.html">kernel_2.6.33.1</a></li><li class="navelem"><a class="el" href="../../dir_20c5e2ce0b5aae09914675fb60613a2c.html">src</a></li><li class="navelem"><a class="el" href="../../dir_621f7c06e37050d77f8420b7e758ce28.html">proxyfs</a></li><li class="navelem"><a class="el" href="../../d9/d21/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__helper_8h.html">proxyfs_helper.h</a></li>
    <li class="footer">Generated on Mon Apr 1 2013 16:10:17 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
