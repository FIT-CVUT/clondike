<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_3.7.1/src/proxyfs/proxyfs_proxy_file.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">proxyfs_proxy_file.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * @file proxyfs_proxy_file.c - Main client file class (used by proxyfs_client_task)</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *                      </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * Date: 08/02/2007</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * Author: Petr Malat</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * $Id: proxyfs_proxy_file.c,v 1.7 2008/05/02 19:59:20 stavam2 Exp $</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * This file is part of Proxy filesystem (ProxyFS)</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * Copyleft (C) 2007 Petr Malat</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * ProxyFS is free software; you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * ProxyFS is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * along with this program; if not, write to the Free Software</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;linux/types.h&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;linux/wait.h&gt;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;asm/uaccess.h&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a15677eb23fa94403dbb88ef45dbde134">   34</a></span>&#160;<span class="preprocessor">#define PROXYFS_PROXY_FILE_PRIVATE</span></div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#af6343798a11829dc93dfb6f545a7536d">   35</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define PROXYFS_PROXY_FILE_PROTECTED // Own header</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../db/d33/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8h.html">proxyfs_proxy_file.h</a>&quot;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/df2/kernel__3_87_81_2src_2proxyfs_2proxyfs__peer_8h.html">proxyfs_peer.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d4/d1d/kernel__3_87_81_2src_2proxyfs_2proxyfs__ioctl_8h.html">proxyfs_ioctl.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd5/kernel__3_87_81_2src_2proxyfs_2virtual_8h.html">virtual.h</a>&quot;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Write to file from user space buffer </span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"> * @param *buf - pointer to data in userspace</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"> * @param count - size of data</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"> * @return the number of bytes written or error (negative number)</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gad733540f4f45cc23a1a323bd0f3bc551">   48</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gad733540f4f45cc23a1a323bd0f3bc551" title="&lt;&lt;public&gt;&gt; Write to file from user space buffer">proxyfs_proxy_file_write_user</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <a class="code" href="../../d6/da1/kernel__2_86_833_81_2src_2proxyfs_2virtual_8h.html#a73a1f6479e17bb3acc879d0d0caeadaa">VIRTUAL_FUNC</a>(write_user, buf, count);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;}</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a5b627881b4d10d07153deb9a28435bf9">   54</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a5b627881b4d10d07153deb9a28435bf9">virtual_proxyfs_proxy_file_read_user</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>) {</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <a class="code" href="../../d6/da1/kernel__2_86_833_81_2src_2proxyfs_2virtual_8h.html#a73a1f6479e17bb3acc879d0d0caeadaa">VIRTUAL_FUNC</a>(read_user, buf, count);</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;}</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Read from file to user space buffer </span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"> * @param *buf - pointer to buffer in userspace</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment"> * @param count - size of data</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment"> * @return the number of bytes read or error (negative number)</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gaed9be391b9d0edca16db9a7cc57410b4">   65</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gaed9be391b9d0edca16db9a7cc57410b4" title="&lt;&lt;public&gt;&gt; Read from file to user space buffer">proxyfs_proxy_file_read_user</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>)</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;{</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    u_int32_t read_count = <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a5b627881b4d10d07153deb9a28435bf9">virtual_proxyfs_proxy_file_read_user</a>(<span class="keyword">self</span>, buf, count);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    msg = <a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#gae386d833d535603242dfdff6e97cdc2f" title="&lt;&lt;public&gt;&gt; Proxyfs message constructor">proxyfs_msg_compose_new</a>(<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga5018eba84874e3d11b71002e5f82035c" title="&lt;&lt;public&gt;&gt; msg_num for message which can be send as reply for MSG_WRITE">MSG_WRITE_RESP</a>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)),</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keyword">sizeof</span>(u_int32_t), &amp;read_count, 0 );            </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <a class="code" href="../../d5/d8c/group__proxyfs__client__class.html#ga0b7563077d76effeebc0b23f425d6716" title="&lt;&lt;public&gt;&gt; Asynchronously sends a message">proxyfs_client_send_message</a>( <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;task, <span class="keyword">self</span>, msg );</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">return</span> read_count;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;}</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">/** &lt;&lt;private&gt;&gt; Writes to file from peer - writes to read buffer </span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"> * @param *buf - pointer to data in kernelspace</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment"> * @param count - size of data</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment"> * @return the number of bytes written </span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00084"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a9f1f47158d701e551ce2074dfb538b0f">   84</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a9f1f47158d701e551ce2074dfb538b0f" title="&lt;&lt;private&gt;&gt; Writes to file from peer - writes to read buffer">proxyfs_proxy_file_write_from_peer</a>(<span class="keyword">struct</span> proxyfs_file_t *<span class="keyword">self</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;{</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordtype">int</span> lenght = 0;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    down( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;read_buf_sem );</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keywordflow">if</span>( count == 0 ){</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga09bf2c02a87032c44fd9872fa157bf8e" title="&lt;&lt;public&gt;&gt; Set file status">proxyfs_file_set_status</a>( <span class="keyword">self</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gac775023e1c5c55530d0a7bc47cfaecfb" title="We are at and of file.">PROXYFS_FILE_READ_EOF</a> );</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;EOF on file %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<span class="keyword">self</span>));</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        lenght = <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga02fa552933482bedf22c9f75f80d57d9" title="&lt;&lt;public&gt;&gt; Write to buffer">circ_buf_write</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;read_buf, buf, count );</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    up( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;read_buf_sem );</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO4, <span class="stringliteral">&quot;Waking up sleepers on %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<span class="keyword">self</span>));</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    wake_up( &amp;<a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;waiting_procs );</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">return</span> lenght;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">/** &lt;&lt;private&gt;&gt; Reads from file to peer - reads from write buffer </span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"> * @param *buf - pointer to buffer in kernelspace</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"> * @param count - size of data</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"> * @TODO: This is never used, is it correct? The functionality is done directly in task buffer sending..</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"> * @return the number of bytes read or error (negative number)</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00109"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a2068e969141dc90c097f06045fa6ff5c">  109</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a2068e969141dc90c097f06045fa6ff5c" title="&lt;&lt;private&gt;&gt; Reads from file to peer - reads from write buffer">proxyfs_proxy_file_read_to_peer</a>(<span class="keyword">struct</span> proxyfs_file_t *<span class="keyword">self</span>, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>)</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;{</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordtype">int</span> lenght;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    down( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem );</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    lenght = <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga29174e7e08a3bbee37b379e9d1c3ba08" title="&lt;&lt;public&gt;&gt; Nondestructively read from buffer at offset">circ_buf_look_at</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf, buf, count, <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf_unconfirmed);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">if</span>( lenght &gt; 0 )</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keyword">self</span>-&gt;write_buf_unconfirmed += lenght;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    up( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem );</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">return</span> lenght;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;}</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">/** &lt;&lt;private&gt;&gt; Submit that data was written to file on other side </span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment"> * (can be safely deleted from proxyfs_file buffer) </span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment"> * @param count - amount of submited data  </span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00128"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a4bc7d78dba48dc3d8f447358306b86b3">  128</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#a4bc7d78dba48dc3d8f447358306b86b3" title="&lt;&lt;private&gt;&gt; Submit that data was written to file on other side (can be safely deleted from proxyfs_fi...">proxyfs_proxy_file_submit_read_to_peer</a>(<span class="keyword">struct</span> proxyfs_file_t *<span class="keyword">self</span>, <span class="keywordtype">size_t</span> <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>)</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;{</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    down( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem );</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga3ffe404c675cd571b34f8f6fc8d0d89f" title="&lt;&lt;public&gt;&gt; Adjust read pointer">circ_buf_adjust_read_ptr</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf, count);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keyword">self</span>-&gt;write_buf_unconfirmed -= <a class="code" href="../../df/dad/kernel__2_86_833_81_2src_2tcmi_2migration_2tcmi__npm__params_8c.html#acc026454809c9e854f4ce3e7aec89377">count</a>;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    up( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem );</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Waking up file after peer read (%lu). Unconfirmed size : %lu&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)count, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf_unconfirmed);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    wake_up( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;waiting_procs );</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;}</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Interruptible wait on file </span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"> * @param status - status on which function returns</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment"> * @return - file status or zero if interrupted by signal</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga0957a03255bb2c20e99bf5453e3ba03e">  146</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga0957a03255bb2c20e99bf5453e3ba03e" title="&lt;&lt;public&gt;&gt; Interruptible wait on file">proxyfs_proxy_file_wait_interruptible</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keywordtype">unsigned</span> status)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;{</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordtype">unsigned</span> rtn = 0;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;wait:   <span class="keywordflow">if</span> ( wait_event_interruptible( <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;waiting_procs, </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>), status ) ||</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#ga8947b90fdcf4dc5fbc4857d0d060bf2b" title="&lt;&lt;public&gt;&gt; Getter of peer state">proxyfs_peer_get_state</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;peer) != <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#gga30b4ed2721f174baa3012a7c9a673f43af3d87f56116881c391433b49524cad57">PEER_CONNECTED</a>) == -ERESTARTSYS) </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#ga8947b90fdcf4dc5fbc4857d0d060bf2b" title="&lt;&lt;public&gt;&gt; Getter of peer state">proxyfs_peer_get_state</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;peer) != <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#gga30b4ed2721f174baa3012a7c9a673f43af3d87f56116881c391433b49524cad57">PEER_CONNECTED</a> ) {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Peer not connected in wait. Peer state: %d\n&quot;</span>, <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#ga8947b90fdcf4dc5fbc4857d0d060bf2b" title="&lt;&lt;public&gt;&gt; Getter of peer state">proxyfs_peer_get_state</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;peer));      </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga0500df7efcc31d752a22e40d51ee2b80" title="The file is opened and both sides known about it.">PROXYFS_FILE_CLOSED</a>; <span class="comment">// TODO: Or rather some BROKEN state?</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        }</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        rtn = <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>), status );</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Waiting on state: %u ... was interrupted in state %u\n&quot;</span>, status, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>), status ));</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordflow">if</span>( rtn &amp; status)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="keywordflow">return</span> rtn;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keywordflow">goto</span> wait;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;}</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Interruptible wait for space in file </span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment"> * @param space - wanted amount of bytes</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment"> * @return - file status or zero if interrupted by signal</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00173"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gac0acfce3dd7f0b3e2a10323343c2f6f0">  173</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gac0acfce3dd7f0b3e2a10323343c2f6f0" title="&lt;&lt;public&gt;&gt; Interruptible wait for space in file">proxyfs_proxy_file_wait_for_space_interruptible</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keywordtype">unsigned</span> space)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;{</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">if</span>( wait_event_interruptible( <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;waiting_procs, </div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <a class="code" href="../../d4/d27/group__circ__buf__clas.html#gab9f1d2fcd5ef64fc22c52fb44847e8a0" title="&lt;&lt;public&gt;&gt; get total free space in buffer">circ_buf_free_space</a>( &amp;<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf ) &gt;= space) == -ERESTARTSYS )</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>), 0xffffFFFF );</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    }</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;}</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Do ioctl on remote file</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment"> * @param cmd - ioctl cmd</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment"> * @param arg - ioctl arg</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment"> * @return - return code of ioctl</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00190"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab5441b421f8ff6a78d75935d3a8abecc">  190</a></span>&#160;<span class="keywordtype">long</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab5441b421f8ff6a78d75935d3a8abecc" title="&lt;&lt;public&gt;&gt; Do ioctl on remote file">proxyfs_proxy_file_ioctl_user</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arg)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;{</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_info;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg_resp;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">size_t</span> arg_size;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordtype">void</span> *ker_buf = NULL;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    u_int32_t command = cmd;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordtype">long</span> rtn = -ERESTARTSYS;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    ioctl_info = <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#ae637eabe129538b62d3036da7d3af08a">ioctl_get_info</a>(cmd);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    arg_size = <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a0bc48cd9b9d7291051f0839179a94fdb">IOCTL_ARG_SIZE</a>(ioctl_info);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="comment">// Check access to memory </span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a4acf918819750ad5620a96e5d7421e35">IOCTL_WILL_READ</a>(ioctl_info) &amp;&amp; !access_ok(VERIFY_WRITE, (<span class="keywordtype">void</span>*)arg, arg_size) ){</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Bad read pointer&quot;</span>);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a000a67ff749066fae84e65a90ba6afd4">IOCTL_WILL_WRITE</a>(ioctl_info) &amp;&amp; !access_ok(VERIFY_READ, (<span class="keywordtype">void</span>*)arg, arg_size) ){</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Bad write pointer&quot;</span>);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="comment">// empty write buf</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">switch</span> ( <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga0957a03255bb2c20e99bf5453e3ba03e" title="&lt;&lt;public&gt;&gt; Interruptible wait on file">proxyfs_proxy_file_wait_interruptible</a>(<span class="keyword">self</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga4d01fcbb095821daa8adc7ea010e56b8" title="There are no data pending in write buffer (read only state)">PROXYFS_FILE_ALL_WRITTEN</a> ) ) {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <span class="keywordflow">return</span> -ERESTARTSYS;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga0500df7efcc31d752a22e40d51ee2b80" title="The file is opened and both sides known about it.">PROXYFS_FILE_CLOSED</a>:</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="comment">// Otherwise process further</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a000a67ff749066fae84e65a90ba6afd4">IOCTL_WILL_WRITE</a>(ioctl_info) ){</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        ker_buf = kmalloc( arg_size + <span class="keyword">sizeof</span>(u_int32_t), GFP_KERNEL );</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">if</span>( ker_buf == NULL ){</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Allocating memory for message data failed&quot;</span>);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">goto</span> exit0;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        *(u_int32_t*)ker_buf = command;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">if</span>( __copy_from_user( ker_buf + <span class="keyword">sizeof</span>(u_int32_t), (<span class="keywordtype">void</span>*)arg, arg_size ) != 0 )</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        msg = <a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga60323723423ceaadf6fe16da2243d9b8" title="&lt;&lt;public&gt;&gt; Proxyfs message constructor">proxyfs_msg_new</a>(<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga8ac355ed0e800684c76ce1d208bbc3e7" title="&lt;&lt;public&gt;&gt; msg_num for ioctl message">MSG_IOCTL</a>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)), <span class="keyword">sizeof</span>(u_int32_t) + arg_size, ker_buf); </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keywordflow">if</span>(msg == NULL)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            <span class="keywordflow">goto</span> exit1;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    }</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        msg = <a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga60323723423ceaadf6fe16da2243d9b8" title="&lt;&lt;public&gt;&gt; Proxyfs message constructor">proxyfs_msg_new</a>(<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga8ac355ed0e800684c76ce1d208bbc3e7" title="&lt;&lt;public&gt;&gt; msg_num for ioctl message">MSG_IOCTL</a>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)), <span class="keyword">sizeof</span>(u_int32_t), &amp;command); </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">if</span>(msg == NULL)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">goto</span> exit0;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    }</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    msg_resp = <a class="code" href="../../d5/d8c/group__proxyfs__client__class.html#gaa45a08a64f9738ddf6126ed360c94cb7" title="&lt;&lt;public&gt;&gt; Forward a syscall on file">proxyfs_client_do_syscall</a>(<a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;task, <span class="keyword">self</span>, msg);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordflow">if</span>( msg_resp ){</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        rtn = msg_resp-&gt;<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#a881a537e78b1ef059ad37973c7d68ad8" title="Message header.">header</a>.<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#a59b017fd913197d5d020b4d1e6c3419b" title="Open structure...">data</a>[0];</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">if</span>( <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a4acf918819750ad5620a96e5d7421e35">IOCTL_WILL_READ</a>(ioctl_info) ){</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="keywordflow">if</span>( __copy_to_user( (<span class="keywordtype">void</span>*)arg, &amp;msg_resp-&gt;<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#a881a537e78b1ef059ad37973c7d68ad8" title="Message header.">header</a>.<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#a59b017fd913197d5d020b4d1e6c3419b" title="Open structure...">data</a>[1], arg_size ) != 0 )</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Copying result back failed&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        kfree( msg_resp );  </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    }</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d2/dc9/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__ioctl_8h.html#a000a67ff749066fae84e65a90ba6afd4">IOCTL_WILL_WRITE</a>(ioctl_info) )</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        kfree(ker_buf);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">return</span> rtn;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;exit1:</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    kfree(ker_buf);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;exit0:</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">return</span> -ERESTARTSYS;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;}</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Close proxyfile</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment"> * @return zero on succes</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00268"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga786e04c56d3383d9a73bddd70ab6eae0">  268</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga786e04c56d3383d9a73bddd70ab6eae0" title="&lt;&lt;public&gt;&gt; Close proxyfile">proxyfs_proxy_file_close</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;{</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg_resp;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordtype">long</span> rtn = -ERESTARTSYS;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    u_int32_t exitting = current-&gt;flags &amp; PF_EXITING;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Close proxy file requested. Ident: %lu Exitting: %d&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)), exitting );</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">// We have to wait for a write buffer empty event..</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="comment">// TODO: however, if the peer connection is broken, this will never happen, and the close method will block.. what to do? Likely we should wait with some long timeout and then just break (or at least recheck connection)</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga0957a03255bb2c20e99bf5453e3ba03e" title="&lt;&lt;public&gt;&gt; Interruptible wait on file">proxyfs_proxy_file_wait_interruptible</a>(<span class="keyword">self</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga4d01fcbb095821daa8adc7ea010e56b8" title="There are no data pending in write buffer (read only state)">PROXYFS_FILE_ALL_WRITTEN</a> ) == 0 ) {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#abc23c8dde04f89ca72fc5035015a65e7">minfo</a>(ERR2, <span class="stringliteral">&quot;Closing of ident: %lu failed. Not all written&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)));</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="keywordflow">return</span> -ERESTARTSYS;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    msg = <a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga60323723423ceaadf6fe16da2243d9b8" title="&lt;&lt;public&gt;&gt; Proxyfs message constructor">proxyfs_msg_new</a>(<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga44dca88b5b5105e02e2db8aff8bae5ed" title="&lt;&lt;public&gt;&gt; msg_num for message which is send when closing file">MSG_CLOSE</a>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)), <span class="keyword">sizeof</span>(exitting), &amp;exitting); </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">if</span>(msg != NULL){</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        msg_resp = <a class="code" href="../../d5/d8c/group__proxyfs__client__class.html#gaa45a08a64f9738ddf6126ed360c94cb7" title="&lt;&lt;public&gt;&gt; Forward a syscall on file">proxyfs_client_do_syscall</a>(<a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;task, <span class="keyword">self</span>, msg);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="comment">// What the fck?????</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span>( msg_resp == (<span class="keywordtype">void</span>*)<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#gae39a4d97bf64f21cba02de89bb73f92d" title="&lt;&lt;public&gt;&gt; msg_num for message which can be send as reply for MSG_CLOSE">MSG_CLOSE_RESP</a> )</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            rtn = 0;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  </div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">if</span> ( rtn != 0 &amp;&amp; <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#ga8947b90fdcf4dc5fbc4857d0d060bf2b" title="&lt;&lt;public&gt;&gt; Getter of peer state">proxyfs_peer_get_state</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;peer) != <a class="code" href="../../d3/d52/group__proxyfs__peer__class.html#gga30b4ed2721f174baa3012a7c9a673f43af3d87f56116881c391433b49524cad57">PEER_CONNECTED</a>) {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;          <span class="comment">// Even if our remote syscall has failed, we have to pretend it succeded as the peer is no longer connected and there is no chance of further close success</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;          rtn = 0;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Close proxy file request DONE, Res: %ld&quot;</span>, rtn);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">return</span> rtn;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;}</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Fsync proxyfile and coresponding real file</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment"> * @return zero on succes</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00308"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gad6c55519101a728f1fee6ac262975c78">  308</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gad6c55519101a728f1fee6ac262975c78" title="&lt;&lt;public&gt;&gt; Fsync proxyfile and coresponding real file">proxyfs_proxy_file_fsync</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t *<span class="keyword">self</span>)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;{</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#dd/d9d/structproxyfs__msg" title="Proxyfs message structure.">proxyfs_msg</a> *msg_resp;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="keywordtype">long</span> rtn = -ERESTARTSYS;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Fsync requested. Ident: %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)));</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// empty write buf</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">switch</span> ( <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga0957a03255bb2c20e99bf5453e3ba03e" title="&lt;&lt;public&gt;&gt; Interruptible wait on file">proxyfs_proxy_file_wait_interruptible</a>(<span class="keyword">self</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga4d01fcbb095821daa8adc7ea010e56b8" title="There are no data pending in write buffer (read only state)">PROXYFS_FILE_ALL_WRITTEN</a> ) ) {</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Cannot fsync, interrupted. Ident: %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)));</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            <span class="keywordflow">return</span> -ERESTARTSYS;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga0500df7efcc31d752a22e40d51ee2b80" title="The file is opened and both sides known about it.">PROXYFS_FILE_CLOSED</a>:</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Cannot fsync, already closed. Ident: %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)));</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Fsync all written, may proceed&quot;</span>);      </div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="comment">// Otherwise process further</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    }</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO2, <span class="stringliteral">&quot;Sending fsync request. Ident: %lu&quot;</span>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)));</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    msg = <a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga60323723423ceaadf6fe16da2243d9b8" title="&lt;&lt;public&gt;&gt; Proxyfs message constructor">proxyfs_msg_new</a>(<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga225b5499b870c6d6ce98c26e8a92c82d" title="&lt;&lt;public&gt;&gt; msg_num for message which is send when syncing file">MSG_FSYNC</a>, <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga98106c38478a4df7b861052d341a0578" title="&lt;&lt;public&gt;&gt; Get file identifier">proxyfs_file_get_file_ident</a>(<a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)), 0, NULL); </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordflow">if</span>(msg != NULL){</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        msg_resp = <a class="code" href="../../d5/d8c/group__proxyfs__client__class.html#gaa45a08a64f9738ddf6126ed360c94cb7" title="&lt;&lt;public&gt;&gt; Forward a syscall on file">proxyfs_client_do_syscall</a>(<a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;task, <span class="keyword">self</span>, msg);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keywordflow">if</span>( msg_resp == (<span class="keywordtype">void</span>*)<a class="code" href="../../dc/d71/group__proxyfs__msg__class.html#ga8f28952dd33558e4590ca29978cbb502" title="&lt;&lt;public&gt;&gt; msg_num for message which can be send as reply for MSG_FSYNC">MSG_FSYNC_RESP</a> )</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            rtn = 0;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    }</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">return</span> rtn;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Poll call for VFS </span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment"> * @param *wait - pointer to poll table</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment"> * @return - mask of file status</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00346"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gaa9d851b7b5915f5a1d9649cab6a8abdd">  346</a></span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gaa9d851b7b5915f5a1d9649cab6a8abdd" title="&lt;&lt;public&gt;&gt; Poll call for VFS">proxyfs_file_poll</a>(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> poll_table_struct *wait)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;{</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keyword">struct </span>proxyfs_proxy_file_t *proxyfile = file-&gt;private_data;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordtype">unsigned</span> mask = 0;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    poll_wait(file, &amp;proxyfile-&gt;waiting_procs, wait);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(proxyfile), <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga07424b1d364a4cb66460f2d9642b71d8" title="There is space in read buffer (read only state)">PROXYFS_FILE_CAN_READ</a> ) )</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        mask |= POLLIN | POLLRDNORM;   </div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gaf339a236eacb30281cf28cd69e943722" title="&lt;&lt;public&gt;&gt; Get file status">proxyfs_file_get_status</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(proxyfile), <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#gacab2930b6ceb0439f7a8237a20d7924b" title="There is space in write buffer (read only state)">PROXYFS_FILE_CAN_WRITE</a> ) )</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            mask |= POLLOUT | POLLWRNORM; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keywordflow">return</span> mask;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">/** &lt;&lt;private&gt;&gt; Get maximum amount and address of data, that can be read at one time</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment"> * @param *self - pointer to this file instance</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment"> * @param *total_size - pointer to size_t into which a total available data count will be written</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment"> * @param *size - pointer to size_t into which the data size will be written </span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment"> * @param **addr - pointer to void* into which the data address will be written </span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00367"></a><span class="lineno"><a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#abef89c1dbcc8ddb1d8ad296c3073ec6a">  367</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html#abef89c1dbcc8ddb1d8ad296c3073ec6a" title="&lt;&lt;private&gt;&gt; Get maximum amount and address of data, that can be read at one time">proxyfs_proxy_file_write_buf_info</a>(<span class="keyword">struct</span> proxyfs_file_t *<span class="keyword">self</span>, <span class="keywordtype">size_t</span>* total_size, <span class="keywordtype">size_t</span>* <a class="code" href="../../d9/d05/kernel__2_86_833_81_2src_2tcmi_2comm_2tcmi__p__emigrate__msg_8h.html#af8fd9ce16b371c8a3bf5e0b37a69419f" title="size of the checkpoint name in bytes (including trailing zero)">size</a>, <span class="keywordtype">void</span>** addr)</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;{</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    down( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem );</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    *total_size = <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga3004ef37f6c2f6542b3f65e54151e620" title="&lt;&lt;public&gt;&gt; get count of total data contained in the buffer">circ_buf_count</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf );</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    *size = <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga41d1f494f53a00e4654c8aedada9b046" title="&lt;&lt;public&gt;&gt; Returns maximum amount of data which are continuos - can by copied with one memcpy call...">circ_buf_get_read_size</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf );</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    *addr = <a class="code" href="../../d4/d27/group__circ__buf__clas.html#ga40f24aba8f8c1498274799b8206e27b1" title="&lt;&lt;public&gt;&gt; Returns base address for reading -">circ_buf_get_read_addr</a>( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf );</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    up( &amp; <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#gab2e4bbb0b934c20b6ce5f0e834d400ea" title="&lt;&lt;public&gt;&gt; Cast to struct proxyfs_proxy_file_t *">PROXYFS_PROXY_FILE</a>(<span class="keyword">self</span>)-&gt;write_buf_sem ); </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;}</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Initialize proxyfs_file struct</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment"> * @param self - pointer to uninitialized proxyfs_proxy_file_t structure</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment"> * @return zero on success </span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00383"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga739e370e057295d11ec4a5d0f1994073">  383</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga739e370e057295d11ec4a5d0f1994073" title="&lt;&lt;public&gt;&gt; Initialize proxyfs_file struct">proxyfs_proxy_file_init</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t* <span class="keyword">self</span>)</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;{</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordtype">int</span> rtn;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">if</span>( (rtn = <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga104071e772f98e9a9151a6f9eaff5cfa" title="&lt;&lt;public&gt;&gt; Initialize proxyfs_file struct">proxyfs_file_init</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>) )) == 0 ){</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        sema_init(&amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;write_buf_sem, 1);        <span class="comment">// Replaced init_MUTEX macro to sema_init by Jiri Rakosnik</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        sema_init(&amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;read_buf_sem, 1);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        init_waitqueue_head( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;waiting_procs );</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>)-&gt;ops = &amp;proxy_file_ops;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    }</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">return</span> rtn;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;}</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">/** &lt;&lt;public&gt;&gt; Deinitialize proxyfs_file struct</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment"> * @param self - pointer to uninitialized proxyfs_proxy_file_t structure</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment"> * @return zero on success </span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment"> * */</span></div>
<div class="line"><a name="l00402"></a><span class="lineno"><a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga8c4445187e166dccddc4893af9d53632">  402</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../da/d8e/group__proxyfs__proxy__file__class.html#ga8c4445187e166dccddc4893af9d53632" title="&lt;&lt;public&gt;&gt; Deinitialize proxyfs_file struct">proxyfs_proxy_file_destroy</a>(<span class="keyword">struct</span> proxyfs_proxy_file_t* <span class="keyword">self</span>)</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;{</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    wake_up( &amp; <a class="code" href="../../d9/d03/kernel__2_86_833_81_2src_2proxyfs_2proxyfs__server_8c.html#acffc38573c809dad4512ce637724ab7e">self</a>-&gt;waiting_procs );</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga5bbed7e844f5afab2fbd943457de4bf6" title="&lt;&lt;public&gt;&gt; Deinitialize proxyfs_file struct">proxyfs_file_destroy</a>( <a class="code" href="../../d1/d14/group__proxyfs__file__class.html#ga35d2463a834ca99968a077d96dd28ba8" title="Cast to struct proxyfs_file_t*.">PROXYFS_FILE</a>(<span class="keyword">self</span>) );</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_08d237fc27d4ecd563f71c5d52f2fecc.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_08cfbe165ea603e6d179ff1f702f26c2.html">kernel_3.7.1</a></li><li class="navelem"><a class="el" href="../../dir_54993795d38a4b0939659b8e486bb0f5.html">src</a></li><li class="navelem"><a class="el" href="../../dir_aa8b60a6091b8198c318e35dcf4e6bae.html">proxyfs</a></li><li class="navelem"><a class="el" href="../../dd/d09/kernel__3_87_81_2src_2proxyfs_2proxyfs__proxy__file_8c.html">proxyfs_proxy_file.c</a></li>
    <li class="footer">Generated on Mon Apr 1 2013 16:09:50 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
