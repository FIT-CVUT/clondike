<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_2.6.33.1/src/ccfs/filter.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">filter.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;linux/spinlock.h&gt;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &lt;linux/list.h&gt;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;linux/err.h&gt;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;linux/fs.h&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;linux/file.h&gt;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;asm/page.h&gt;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;linux/sched.h&gt;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;linux/kthread.h&gt;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;linux/wait.h&gt;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;linux/pagemap.h&gt;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &lt;linux/pagevec.h&gt;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;dbg.h&gt;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/d55/kernel__2_86_833_81_2src_2ccfs_2filter_8h.html">filter.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno"><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html">   18</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a> {<span class="comment"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">    /** For enlistment */</span></div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437">   20</a></span>&#160;    <span class="keyword">struct </span>list_head <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437" title="For enlistment.">head</a>;<span class="comment"></span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">    /** Pattern itself */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1">   22</a></span>&#160;    <span class="keywordtype">char</span>* <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a>;</div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">   23</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">pattern_length</a>;<span class="comment"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">    /** Files creation data has to be older than this time */</span></div>
<div class="line"><a name="l00025"></a><span class="lineno"><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a">   25</a></span>&#160;    <span class="keyword">struct </span>timespec <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a>;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;};</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#af5b8b6927e23132bc034e75a5956a107">   28</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#af5b8b6927e23132bc034e75a5956a107">create_filter</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a> = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> filter), GFP_KERNEL);</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="keywordflow">if</span> ( !filter )</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    INIT_LIST_HEAD(&amp;filter-&gt;<a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a206d0ddbbf11a630e9cfdcd3f9fb747e" title="Pattterns, that can be matched.">patterns</a>);</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="keywordflow">return</span> filter;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;}</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a7889c58e021a442a2a428a598dfd6a5a">   38</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a7889c58e021a442a2a428a598dfd6a5a">destroy_filter</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>) {</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a> *<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437" title="For enlistment.">head</a>, *tmp;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="keywordflow">if</span> ( !filter )</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        list_for_each_entry_safe(head, tmp, &amp;filter-&gt;<a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a206d0ddbbf11a630e9cfdcd3f9fb747e" title="Pattterns, that can be matched.">patterns</a>, head) {          </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;                list_del(&amp;head-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437" title="For enlistment.">head</a>);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        kfree(head);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;         </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    kfree(filter);</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;}</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#aac80972c80264c0b761a863e60d8f9af">   52</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#aac80972c80264c0b761a863e60d8f9af" title="Parses filter definition.">parse_filter</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>, <span class="keywordtype">char</span>* definition) {</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordtype">char</span>* p;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">while</span> ((p = strsep(&amp;definition, <span class="stringliteral">&quot;:&quot;</span>)) != NULL) {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        <span class="keywordflow">if</span> (!*p)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a0ddef6be4dfcbe3f731883a35791ef47" title="Registers a new patter to the filter.">add_filter_pattern</a>(filter, p, strcspn(p, <span class="stringliteral">&quot;:&quot;</span>));</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    }</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;}</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a0ddef6be4dfcbe3f731883a35791ef47">   64</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a0ddef6be4dfcbe3f731883a35791ef47" title="Registers a new patter to the filter.">add_filter_pattern</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>, <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">pattern_length</a>) {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a>* <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a> = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> filter_pattern), GFP_KERNEL);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    printk(<span class="stringliteral">&quot;Adding filter pattern: %s (%d)\n&quot;</span>, pattern, pattern_length);</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">if</span> ( !filter_pattern )</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">if</span> ( strcmp(pattern, <span class="stringliteral">&quot;OLD&quot;</span>) == 0 ) {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;      filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a> = NULL;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a> = CURRENT_TIME;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;      <span class="comment">// Consider also files created in last hour to be new files.. as we may assume they may change again soon (not realy smart but should be good enough for our purposes)     </span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a>.tv_sec = filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a>.tv_sec - 3600;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    } <span class="keywordflow">else</span> {    </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;      filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a> = kmalloc(pattern_length, GFP_KERNEL);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;      <span class="keywordflow">if</span> ( !filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a> ) {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;          kfree(filter_pattern);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;          <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;      memcpy(filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a>, pattern, pattern_length);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">pattern_length</a> = <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">pattern_length</a>;        </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    list_add(&amp;filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437" title="For enlistment.">head</a>, &amp;filter-&gt;<a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a206d0ddbbf11a630e9cfdcd3f9fb747e" title="Pattterns, that can be matched.">patterns</a>);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;}</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno"><a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a5443f0b8c8ff54516356c8c813d8b5c1">   92</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a5443f0b8c8ff54516356c8c813d8b5c1">pattern_matches</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a>* <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a>, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">int</span> name_length, <span class="keyword">struct</span> timespec* ctime, umode_t umode) {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordtype">int</span> name_index = name_length - 1;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="keywordtype">int</span> pattern_index = filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#ab986ffec74774721261107794e4ecf76">pattern_length</a> - 1;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a> = filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a>;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordflow">if</span> ( filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a> == NULL ) {</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      <span class="comment">/* Match time pattern. Do not check age for dir, they can be always cached since readdir is uncached anyway */</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      <a class="code" href="../../de/d8f/kernel__2_86_833_81_2src_2dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Date compare: %d vs %d&quot;</span>, &amp;filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a>.tv_sec, ctime-&gt;tv_sec);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;      <span class="keywordflow">return</span> S_ISDIR(umode) || timespec_compare(&amp;filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a5fa25dd49a377f4bdb3c50df3ce37a0a" title="Files creation data has to be older than this time.">older_than</a>, ctime) &gt; 0;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    } <span class="keywordflow">else</span> {            </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      <span class="comment">/* Match string pattern */</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="keywordflow">while</span> ( name_index &gt; -1 &amp;&amp; pattern_index &gt; -1 ) {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;          <span class="keywordflow">if</span> ( pattern[pattern_index] == <span class="charliteral">&#39;*&#39;</span> ) {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;              <span class="keywordflow">if</span> ( pattern_index != 0 ) {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                  printk(KERN_WARNING <span class="stringliteral">&quot;Illegal pattern &#39;%s&#39;! Pattern must have * only at the beggining!\n&quot;</span>, filter_pattern-&gt;<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a48881496dd9d822896b8e6a1e58ee6e1" title="Pattern itself.">pattern</a>);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;              }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;              <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pattern[pattern_index] != name[name_index] ) {</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;              <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;          }</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;          name_index--;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;          pattern_index--;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      }</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    }</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">return</span> name_index == pattern_index;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">/** Returns 1, if name matches any of the filter patterns. 0 otherwise */</span></div>
<div class="line"><a name="l00122"></a><span class="lineno"><a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a5b54778905740cdbd3ff85527360b9df">  122</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a5b54778905740cdbd3ff85527360b9df" title="Returns 1, if name matches any of the filter patterns.">filter_matches</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>* <a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#d2/d9e/structfilter" title="Container of filters.">filter</a>, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">int</span> name_length, <span class="keyword">struct</span> timespec *ctime, umode_t umode) {</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#d6/dff/structfilter__pattern">filter_pattern</a> *<a class="code" href="../../d6/d3a/kernel__3_87_81_2src_2ccfs_2filter_8c.html#a75bc468446679ab70be85b5d9c6a5437" title="For enlistment.">head</a>;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordflow">if</span> ( !filter )</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        list_for_each_entry(head, &amp;filter-&gt;<a class="code" href="../../dd/db2/kernel__3_87_81_2src_2ccfs_2filter_8h.html#a206d0ddbbf11a630e9cfdcd3f9fb747e" title="Pattterns, that can be matched.">patterns</a>, head) {            </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html#a5443f0b8c8ff54516356c8c813d8b5c1">pattern_matches</a>(head, name, name_length, ctime, umode) )</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_08d237fc27d4ecd563f71c5d52f2fecc.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_351788bb6e23fe2c44c0fb926ab59c0b.html">kernel_2.6.33.1</a></li><li class="navelem"><a class="el" href="../../dir_20c5e2ce0b5aae09914675fb60613a2c.html">src</a></li><li class="navelem"><a class="el" href="../../dir_68be239379f2e7d29b0f054b419a7500.html">ccfs</a></li><li class="navelem"><a class="el" href="../../d8/df1/kernel__2_86_833_81_2src_2ccfs_2filter_8c.html">filter.c</a></li>
    <li class="footer">Generated on Mon Apr 1 2013 16:09:46 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
