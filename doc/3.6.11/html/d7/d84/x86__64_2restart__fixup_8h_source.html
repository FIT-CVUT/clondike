<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_3.6.11/src/arch/x86_64/restart_fixup.h Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
   <div id="projectbrief">Supported to Linux kernel 3.6.11</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/d84/x86__64_2restart__fixup_8h_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">restart_fixup.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/d84/x86__64_2restart__fixup_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#ifndef ARG_X86_64_RESTART_FIXUP_H</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define ARG_X86_64_RESTART_FIXUP_H</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// TODO: Use vsdo attribute of mm_context to check for correct location of vsdo. It is not really supported by 64 bit now, but 32 bit kernel is using it and we must be able to handle this case also here!</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// TODO: Disable making of checkpoints, when we are in some part of vsdo other than syscall itself (otherwise we have to fixup stack &amp; args for every possible EIP)</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;asm/processor.h&gt;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">/** We need to export this in order to prepare vsyscall page for 32 bit applications */</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc" title="We need to export this in order to prepare vsyscall page for 32 bit applications.">syscall32_setup_pages</a>(<span class="keyword">struct</span> linux_binprm *bprm, <span class="keywordtype">int</span> exstack);</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">/** </span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * This method is used for handling migration restart. There are 2 cases:</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * Application was in syscall:</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *  We cannot directly restart the syscall, because as a part of process restart we do execve. The execve,</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * if it succeeds, will set EAX to 0. This means, the restarted syscall will not be the original syscall, but sys_restartsyscall.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * Restart syscall is handled by the custom registered method in our case this method.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * Application was not in syscall:</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> *  We cannot simply restart the application, because again the execve will override EAX content! Here we use a special trick.</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * We can assume EAX will contain 0 as in previous case (=execve succeeded, otherwise the program would not start anyway).</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * With EAX == 0 we can set fake EIP just before the vsyscall sysenter (assuming it is mapped in the process on expected address)</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * This way we will get sysretart called immediately and from the special restart function we return proper eax (and eip) in order to make </span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * the application working as expected, with all registers set correctly.</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">/* Commented function because struct restart_block doesn&#39;t contain arg1, arg2 and above all function is not called | by Jiri Rakosnik</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">static long tcmi_restart_fixup(struct restart_block *restart) {</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">    struct pt_regs *regs = task_pt_regs(current);</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">    mdbg(INFO3, &quot;Calling tcmi sys restart. EAX: %08lX (OEAX: %08lX Return EAX: %08lX) SP: %16lX BP: %16lX (Restore BP: %16lX)&quot;, regs_return_value(regs), original_ax(regs), restart-&gt;arg0, stack_pointer(regs), base_pointer(regs), restart-&gt;arg2);</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">    //mdbg(INFO3, &quot;Calling tcmi sys restart. EAX: %08lX (OEAX: %08lX Return EAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;, regs-&gt;eax, regs-&gt;orig_eax, restart-&gt;arg0, regs-&gt;ebx, regs-&gt;ecx, regs-&gt;edx);</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">    // TODO: Reset restart_block? </span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">    // Reset EIP to original value (either again just before the syscall, or on the other completely unrelated address </span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">    regs-&gt;ip = restart-&gt;arg1;           </span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">    // Restore rcx </span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">    regs-&gt;cx = restart-&gt;arg2;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">    // To prevent ECX &amp; EDX clobbering via sysexit </span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">    set_thread_flag(TIF_IRET);</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">    // </span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">    //       This is a trick how to get original EAX onto the stack.. return value of this syscall is what gets onto the stack </span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">      // When the syscall gets executed again (as we again set EIP) it will finally use correct EAX. The other registers are unclobbered and so we do not need to restore them</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">     //  If we were not originally in syscall, we will simply continue with correct EAX where we finished.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">         </span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">    return restart-&gt;arg0;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">/** 64 bit apps do not need to use restart block.. TODO: Do this kernel patch also for 32 bit apps? */</span></div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4">   57</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4" title="This method is used for handling migration restart.">tcmi_resolve_restart_block_64bit_app</a>(<span class="keyword">struct</span> task_struct* task, <span class="keyword">struct</span> pt_regs* regs) {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in 64 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        regs-&gt;ax = regs-&gt;orig_ax;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="comment">// For 64 bit applications we have a modified execve and we use orig_rax to set application rax, so we do not need to do restart trick</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="comment">// Do this only if we are not in syscall, otherwise we want current orig_eax to get into eax register</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        regs-&gt;orig_ax = regs-&gt;ax;           </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;}</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">/** 32 bit apps do not need to use restart block */</span></div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868">   71</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868" title="32 bit apps do not need to use restart block">tcmi_resolve_restart_block_32bit_app</a>(<span class="keyword">struct</span> task_struct* task, <span class="keyword">struct</span> pt_regs* regs, <span class="keyword">enum</span> <a class="code" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9" title="Enumeration representing all supported architecture types.">arch_ids</a> from_arch) {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in 32 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        regs-&gt;ax = regs-&gt;orig_ax;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <span class="keywordflow">if</span> ( boot_cpu_data.x86_vendor == X86_VENDOR_AMD) { <span class="comment">// Fixup needed on AMD, as it does not support syscall in compat mode</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            regs-&gt;sp += 8; <span class="comment">/* Fixup stack pointer.. */</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)) = regs-&gt;bp; <span class="comment">// Fixup stack content.. this will be pushed from stack</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            regs-&gt;bp = regs-&gt;cx; <span class="comment">// This is normally done by 64 bit syscall, so we have to do it manually</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">// For 64 bit applications we have a modified execve and we use orig_rax to set application rax, so we do not need to do restart trick</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="comment">// Do this only if we are not in syscall, otherwise we want current orig_eax to get into eax register</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        regs-&gt;orig_ax = regs-&gt;ax;   </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">if</span> ( regs-&gt;ip == 0xffffe410 &amp;&amp; boot_cpu_data.x86_vendor == X86_VENDOR_AMD) { <span class="comment">// Fixup needed on AMD, as it does not support syscall in compat mode</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in finished 32 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            <span class="comment">/* We were in syscall, but the syscall was not interrupted and so we do not need to restart it */</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            regs-&gt;bp = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)); <span class="comment">// Extract real RBP</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Real rbp was: %08lx.&quot;</span>, regs-&gt;bp);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            regs-&gt;sp += 8; <span class="comment">/* Fixup stack pointer.. */</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)) = regs-&gt;bp; <span class="comment">// Fixup stack content.. this will be pushed from stack</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            regs-&gt;bp = regs-&gt;cx; <span class="comment">// This is normally done by 64 bit syscall, so we have to do it manually</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            regs-&gt;ip = 0xffffe405; <span class="comment">// Modify return address to correct value</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        }               </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"> * Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time. The main motivaction for this is to </span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"> * restore original AX register.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"> * @param task Current task</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"> * @param regs Current registers of the task</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"> * @param is_32bit_application 1 if, the application is 32 bit</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"> * @return 0 on success</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00110"></a><span class="lineno"><a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077">  110</a></span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077" title="Registeres restart block and schedules restart syscall to be executed after the process resumes users...">tcmi_resolve_restart_block</a>(<span class="keyword">struct</span> task_struct* task, <span class="keyword">struct</span> pt_regs* regs, <span class="keyword">enum</span> <a class="code" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9" title="Enumeration representing all supported architecture types.">arch_ids</a> from_arch, <span class="keywordtype">int</span> <a class="code" href="../../d6/db7/tcmi__ckpt_8h.html#a261c3d1e52cdc2e37e08e2dea3f1a138" title="Flag, indicating whether the checkpointed application was 32 bit application (otherwise 64 bit is ass...">is_32bit_application</a>) {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">//struct restart_block* restart = &amp;task-&gt;thread_info-&gt;restart_block;</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Setting tcmi sys restart block. EAX: %08lX (OEAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;</span>, regs-&gt;ax, regs-&gt;orig_ax, regs-&gt;bx, regs-&gt;cx, regs-&gt;dx);   </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">if</span> ( !is_32bit_application )</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4" title="This method is used for handling migration restart.">tcmi_resolve_restart_block_64bit_app</a>(task, regs);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">/* First we have to setup syscall page into 32 process space so that it can do vsyscalls */</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc" title="We need to export this in order to prepare vsyscall page for 32 bit applications.">syscall32_setup_pages</a>(NULL,0) ) {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Failed to install syscall page&quot;</span>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    }</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868" title="32 bit apps do not need to use restart block">tcmi_resolve_restart_block_32bit_app</a>(task, regs, from_arch);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">//return 0;</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_8f82a767cc51fe89d179736eabaccdf4.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_a979464daf01ae794274baf94d64f269.html">kernel_3.6.11</a></li><li class="navelem"><a class="el" href="../../dir_9674632d8583b1c158c2b58e4b736b2e.html">src</a></li><li class="navelem"><a class="el" href="../../dir_d88a362d140e6fc833d9f14fc43fa855.html">arch</a></li><li class="navelem"><a class="el" href="../../dir_cf6ec0d3b50315485aedb1caf7f2f138.html">x86_64</a></li><li class="navelem"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html">restart_fixup.h</a></li>
    <li class="footer">Generated on Sun May 12 2013 19:05:47 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
