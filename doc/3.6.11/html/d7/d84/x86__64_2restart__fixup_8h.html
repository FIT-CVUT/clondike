<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Clondike: C:/CLONDIKE/clondike/sources/kernel_3.6.11/src/arch/x86_64/restart_fixup.h File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Clondike
   </div>
   <div id="projectbrief">Supported to Linux kernel 3.6.11</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/d84/x86__64_2restart__fixup_8h.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">restart_fixup.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;asm/processor.h&gt;</code><br/>
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="../../closed.png" alt="+"/> Include dependency graph for restart_fixup.h:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../db/d5a/x86__64_2restart__fixup_8h__incl.png" border="0" usemap="#C_1_2CLONDIKE_2clondike_2sources_2kernel__3_86_811_2src_2arch_2x86__64_2restart__fixup_8h" alt=""/></div>
</div>
</div>
<p><a href="../../d7/d84/x86__64_2restart__fixup_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a56e87b02c626445de698600fcc84cbcc"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc">syscall32_setup_pages</a> (struct linux_binprm *bprm, int exstack)</td></tr>
<tr class="memdesc:a56e87b02c626445de698600fcc84cbcc"><td class="mdescLeft">&#160;</td><td class="mdescRight">We need to export this in order to prepare vsyscall page for 32 bit applications.  <a href="#a56e87b02c626445de698600fcc84cbcc">More...</a><br/></td></tr>
<tr class="separator:a56e87b02c626445de698600fcc84cbcc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6533b8739f26d6b59576f1200a4c8f4"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4">tcmi_resolve_restart_block_64bit_app</a> (struct task_struct *task, struct pt_regs *regs)</td></tr>
<tr class="memdesc:ab6533b8739f26d6b59576f1200a4c8f4"><td class="mdescLeft">&#160;</td><td class="mdescRight">This method is used for handling migration restart.  <a href="#ab6533b8739f26d6b59576f1200a4c8f4">More...</a><br/></td></tr>
<tr class="separator:ab6533b8739f26d6b59576f1200a4c8f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf4547b9a493ade37dee310865f21868"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868">tcmi_resolve_restart_block_32bit_app</a> (struct task_struct *task, struct pt_regs *regs, enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a> from_arch)</td></tr>
<tr class="memdesc:aaf4547b9a493ade37dee310865f21868"><td class="mdescLeft">&#160;</td><td class="mdescRight">32 bit apps do not need to use restart block  <a href="#aaf4547b9a493ade37dee310865f21868">More...</a><br/></td></tr>
<tr class="separator:aaf4547b9a493ade37dee310865f21868"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ce254bfcbf5391b17d83aba09345077"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a6ce254bfcbf5391b17d83aba09345077">tcmi_resolve_restart_block</a> (struct task_struct *task, struct pt_regs *regs, enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a> from_arch, int <a class="el" href="../../d6/db7/tcmi__ckpt_8h.html#a261c3d1e52cdc2e37e08e2dea3f1a138">is_32bit_application</a>)</td></tr>
<tr class="memdesc:a6ce254bfcbf5391b17d83aba09345077"><td class="mdescLeft">&#160;</td><td class="mdescRight">Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time.  <a href="#a6ce254bfcbf5391b17d83aba09345077">More...</a><br/></td></tr>
<tr class="separator:a6ce254bfcbf5391b17d83aba09345077"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a56e87b02c626445de698600fcc84cbcc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int syscall32_setup_pages </td>
          <td>(</td>
          <td class="paramtype">struct linux_binprm *&#160;</td>
          <td class="paramname"><em>bprm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>exstack</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>We need to export this in order to prepare vsyscall page for 32 bit applications. </p>

<p>Referenced by <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00110">tcmi_resolve_restart_block()</a>.</p>

</div>
</div>
<a class="anchor" id="a6ce254bfcbf5391b17d83aba09345077"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int tcmi_resolve_restart_block </td>
          <td>(</td>
          <td class="paramtype">struct task_struct *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pt_regs *&#160;</td>
          <td class="paramname"><em>regs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a>&#160;</td>
          <td class="paramname"><em>from_arch</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_32bit_application</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Registeres restart block and schedules restart syscall to be executed after the process resumes userspace for first time. </p>
<p>The main motivaction for this is to restore original AX register.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">task</td><td>Current task </td></tr>
    <tr><td class="paramname">regs</td><td>Current registers of the task </td></tr>
    <tr><td class="paramname">is_32bit_application</td><td>1 if, the application is 32 bit </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success </dd></dl>

<p>Definition at line <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00110">110</a> of file <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d6/d01/dbg_8h_source.html#l00210">mdbg</a>, <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc">syscall32_setup_pages()</a>, <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00071">tcmi_resolve_restart_block_32bit_app()</a>, and <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00057">tcmi_resolve_restart_block_64bit_app()</a>.</p>
<div class="fragment"><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                                                                                                                                                {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">//struct restart_block* restart = &amp;task-&gt;thread_info-&gt;restart_block;</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Setting tcmi sys restart block. EAX: %08lX (OEAX: %08lX). EBX: %08lX ECX: %08lX EDX: %08lX&quot;</span>, regs-&gt;ax, regs-&gt;orig_ax, regs-&gt;bx, regs-&gt;cx, regs-&gt;dx);   </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/db7/tcmi__ckpt_8h.html#a261c3d1e52cdc2e37e08e2dea3f1a138" title="Flag, indicating whether the checkpointed application was 32 bit application (otherwise 64 bit is ass...">is_32bit_application</a> )</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4" title="This method is used for handling migration restart.">tcmi_resolve_restart_block_64bit_app</a>(task, regs);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">/* First we have to setup syscall page into 32 process space so that it can do vsyscalls */</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc" title="We need to export this in order to prepare vsyscall page for 32 bit applications.">syscall32_setup_pages</a>(NULL,0) ) {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(ERR3, <span class="stringliteral">&quot;Failed to install syscall page&quot;</span>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    }</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868" title="32 bit apps do not need to use restart block">tcmi_resolve_restart_block_32bit_app</a>(task, regs, from_arch);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">//return 0;</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d7/d84/x86__64_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph.png" border="0" usemap="#d7/d84/x86__64_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph" alt=""/></div>
<map name="d7/d84/x86__64_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph" id="d7/d84/x86__64_2restart__fixup_8h_a6ce254bfcbf5391b17d83aba09345077_cgraph">
<area shape="rect" id="node2" href="../../d7/d84/x86__64_2restart__fixup_8h.html#a56e87b02c626445de698600fcc84cbcc" title="We need to export this in order to prepare vsyscall page for 32 bit applications." alt="" coords="193,5,351,32"/><area shape="rect" id="node3" href="../../d7/d84/x86__64_2restart__fixup_8h.html#aaf4547b9a493ade37dee310865f21868" title="32 bit apps do not need to use restart block" alt="" coords="203,57,341,98"/><area shape="rect" id="node5" href="../../d7/d84/x86__64_2restart__fixup_8h.html#ab6533b8739f26d6b59576f1200a4c8f4" title="This method is used for handling migration restart." alt="" coords="203,122,341,163"/><area shape="rect" id="node4" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call." alt="" coords="401,97,498,124"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aaf4547b9a493ade37dee310865f21868"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int tcmi_resolve_restart_block_32bit_app </td>
          <td>(</td>
          <td class="paramtype">struct task_struct *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pt_regs *&#160;</td>
          <td class="paramname"><em>regs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="../../d2/def/arch__ids_8h.html#adbc45da5aabb1eb49345f13d3eed13a9">arch_ids</a>&#160;</td>
          <td class="paramname"><em>from_arch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>32 bit apps do not need to use restart block </p>

<p>Definition at line <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00071">71</a> of file <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf">is_in_syscall()</a>, and <a class="el" href="../../d6/d01/dbg_8h_source.html#l00210">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00110">tcmi_resolve_restart_block()</a>.</p>
<div class="fragment"><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                                                                                                                                {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in 32 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        regs-&gt;ax = regs-&gt;orig_ax;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <span class="keywordflow">if</span> ( boot_cpu_data.x86_vendor == X86_VENDOR_AMD) { <span class="comment">// Fixup needed on AMD, as it does not support syscall in compat mode</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            regs-&gt;sp += 8; <span class="comment">/* Fixup stack pointer.. */</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)) = regs-&gt;bp; <span class="comment">// Fixup stack content.. this will be pushed from stack</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            regs-&gt;bp = regs-&gt;cx; <span class="comment">// This is normally done by 64 bit syscall, so we have to do it manually</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">// For 64 bit applications we have a modified execve and we use orig_rax to set application rax, so we do not need to do restart trick</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="comment">// Do this only if we are not in syscall, otherwise we want current orig_eax to get into eax register</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        regs-&gt;orig_ax = regs-&gt;ax;   </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">if</span> ( regs-&gt;ip == 0xffffe410 &amp;&amp; boot_cpu_data.x86_vendor == X86_VENDOR_AMD) { <span class="comment">// Fixup needed on AMD, as it does not support syscall in compat mode</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in finished 32 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            <span class="comment">/* We were in syscall, but the syscall was not interrupted and so we do not need to restart it */</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            regs-&gt;bp = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)); <span class="comment">// Extract real RBP</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Real rbp was: %08lx.&quot;</span>, regs-&gt;bp);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            regs-&gt;sp += 8; <span class="comment">/* Fixup stack pointer.. */</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)(regs-&gt;sp)) = regs-&gt;bp; <span class="comment">// Fixup stack content.. this will be pushed from stack</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            regs-&gt;bp = regs-&gt;cx; <span class="comment">// This is normally done by 64 bit syscall, so we have to do it manually</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            regs-&gt;ip = 0xffffe405; <span class="comment">// Modify return address to correct value</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        }               </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-2" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-2-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-2-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-2-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d7/d84/x86__64_2restart__fixup_8h_aaf4547b9a493ade37dee310865f21868_cgraph.png" border="0" usemap="#d7/d84/x86__64_2restart__fixup_8h_aaf4547b9a493ade37dee310865f21868_cgraph" alt=""/></div>
<map name="d7/d84/x86__64_2restart__fixup_8h_aaf4547b9a493ade37dee310865f21868_cgraph" id="d7/d84/x86__64_2restart__fixup_8h_aaf4547b9a493ade37dee310865f21868_cgraph">
<area shape="rect" id="node2" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call." alt="" coords="193,12,290,39"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab6533b8739f26d6b59576f1200a4c8f4"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int tcmi_resolve_restart_block_64bit_app </td>
          <td>(</td>
          <td class="paramtype">struct task_struct *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pt_regs *&#160;</td>
          <td class="paramname"><em>regs</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This method is used for handling migration restart. </p>
<p>There are 2 cases:</p>
<p>Application was in syscall: We cannot directly restart the syscall, because as a part of process restart we do execve. The execve, if it succeeds, will set EAX to 0. This means, the restarted syscall will not be the original syscall, but sys_restartsyscall. Restart syscall is handled by the custom registered method in our case this method.</p>
<p>Application was not in syscall: We cannot simply restart the application, because again the execve will override EAX content! Here we use a special trick. We can assume EAX will contain 0 as in previous case (=execve succeeded, otherwise the program would not start anyway). With EAX == 0 we can set fake EIP just before the vsyscall sysenter (assuming it is mapped in the process on expected address) This way we will get sysretart called immediately and from the special restart function we return proper eax (and eip) in order to make the application working as expected, with all registers set correctly.64 bit apps do not need to use restart block.. TODO: Do this kernel patch also for 32 bit apps? </p>

<p>Definition at line <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00057">57</a> of file <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html">restart_fixup.h</a>.</p>

<p>References <a class="el" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf">is_in_syscall()</a>, and <a class="el" href="../../d6/d01/dbg_8h_source.html#l00210">mdbg</a>.</p>

<p>Referenced by <a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h_source.html#l00110">tcmi_resolve_restart_block()</a>.</p>
<div class="fragment"><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                                                                                                       {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call.">is_in_syscall</a>(regs) ) {</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <a class="code" href="../../d6/d01/dbg_8h.html#a881516d8ffc635f7f0e87468340c80dc">mdbg</a>(INFO3, <span class="stringliteral">&quot;Performing restart in 64 bit syscall.&quot;</span>);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        regs-&gt;ip -= 2;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        regs-&gt;ax = regs-&gt;orig_ax;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="comment">// For 64 bit applications we have a modified execve and we use orig_rax to set application rax, so we do not need to do restart trick</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="comment">// Do this only if we are not in syscall, otherwise we want current orig_eax to get into eax register</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        regs-&gt;orig_ax = regs-&gt;ax;           </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-3" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-3-trigger" src="../../closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-3-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-3-content" class="dyncontent" style="display:none;">
<div class="center"><img src="../../d7/d84/x86__64_2restart__fixup_8h_ab6533b8739f26d6b59576f1200a4c8f4_cgraph.png" border="0" usemap="#d7/d84/x86__64_2restart__fixup_8h_ab6533b8739f26d6b59576f1200a4c8f4_cgraph" alt=""/></div>
<map name="d7/d84/x86__64_2restart__fixup_8h_ab6533b8739f26d6b59576f1200a4c8f4_cgraph" id="d7/d84/x86__64_2restart__fixup_8h_ab6533b8739f26d6b59576f1200a4c8f4_cgraph">
<area shape="rect" id="node2" href="../../d9/dc7/common_2regs_8h.html#a9cc4535df03653446291382d8e8628bf" title="Checks whether a process with specified registers has been in system call." alt="" coords="193,12,290,39"/></map>
</div>
</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_8f82a767cc51fe89d179736eabaccdf4.html">sources</a></li><li class="navelem"><a class="el" href="../../dir_a979464daf01ae794274baf94d64f269.html">kernel_3.6.11</a></li><li class="navelem"><a class="el" href="../../dir_9674632d8583b1c158c2b58e4b736b2e.html">src</a></li><li class="navelem"><a class="el" href="../../dir_d88a362d140e6fc833d9f14fc43fa855.html">arch</a></li><li class="navelem"><a class="el" href="../../dir_cf6ec0d3b50315485aedb1caf7f2f138.html">x86_64</a></li><li class="navelem"><a class="el" href="../../d7/d84/x86__64_2restart__fixup_8h.html">restart_fixup.h</a></li>
    <li class="footer">Generated on Sun May 12 2013 19:05:53 for Clondike by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
