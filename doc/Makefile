###################################################################
#                           Makefile                              #
#                                                                 #
# Description: Builds the documentation                           #
#                                                                 #
# Author: Jan Capek                                               #
# Created: 11/16/2004                                             #
#                                                                 #
# Last modified:                                                  #
#                                                                 #
###################################################################
SUBDIRS     := 


DOXYTOOL = doxygen
DOXYCONF = clondike.cfg
# diagram plotting tool
PLOT = gnuplot

DESC_INPUTFILES = $(shell ls *.desc.in)
DESC_OUTPUTFILES = $(DESC_INPUTFILES:.desc.in=.desc)
# files that are used for extracting the version
VERFILES = ../src/tcmi/tcmi_module.c ../src/kkc/kkc.h ../README

date = $(shell date -I)
tcmi_ver = $(shell cat ../Makefile | perl -n -e 'print $$1 if($$_=~/.*TCMI_VER\s+.*=\s+(.*)\s*.*/);')
kkc_ver = $(shell cat ../Makefile | perl -n -e 'print $$1 if($$_=~/.*KKC_VER\s+.*=\s+(.*)\s*.*/);')
clondike_ver = $(shell cat ../Makefile | perl -n -e 'print $$1 if($$_=~/.*CLONDIKE_VER\s+.*=\s+(.*)\s*.*/);')

# source code statistics prefix
SRC_STATS = src_stats
# plotting script
SRC_STATS_PLT = $(SRC_STATS).plt
# output in PNG
SRC_STATS_PNG = $(SRC_STATS).png
# output in EPS
SRC_STATS_EPS = $(SRC_STATS).eps
# output in PDF
SRC_STATS_PDF = $(SRC_STATS).pdf
# all outputs
SRC_STATS_ALL = $(SRC_STATS_PNG) $(SRC_STATS_EPS) $(SRC_STATS_PDF)
# main dependency - .dat file generated by the main Makefile
SRC_STATS_DAT = $(SRC_STATS).dat

.PHONY: all
all: stats subst docs



docs: $(DOXYCONF)
	@$(DOXYTOOL) $(DOXYCONF)


# make necessary substitutions in the .desc.in files
subst: $(DESC_OUTPUTFILES)

stats: $(SRC_STATS_ALL)

$(SRC_STATS_ALL): $(SRC_STATS_PLT) $(SRC_STATS_DAT)

%.pdf : %.eps
	@echo Generating $@
	@ps2pdf $< 

%.eps : %.dat 
	@echo Generating $@
	@echo set terminal postscript | cat /dev/fd/0 $(SRC_STATS_PLT) | $(PLOT)  > $@

%.png : %.dat 
	@echo Generating $@
	@echo set terminal png | cat /dev/fd/0 $(SRC_STATS_PLT) | $(PLOT)  > $@


%.desc : %.desc.in ../Makefile
	@echo "Performing keyword substitutions in: "$<
	@perl -pe"s/__DATE__/$(date)/;s/__CLDK_VER__/$(clondike_ver)/;s/__KKC_VER__/$(kkc_ver)/; s/__TCMI_VER__/$(tcmi_ver)/;" $< > $@



.PHONY: clean
clean:
	rm -r -f html/ latex/ *~ *.png *.eps *.pdf

